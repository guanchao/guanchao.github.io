---
title: "OpenClaw (åŸClawdBot) å¼€æºé¡¹ç›®æ·±åº¦åˆ†æ"
date: 2026-02-02
draft: false
description: "æ·±å…¥å‰–æ OpenClaw (åŸClawdBot) é¡¹ç›®çš„ Agent å®ç°åŸç†ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£ LLM Agent çš„æ ¸å¿ƒæœºåˆ¶ï¼ŒåŒ…æ‹¬ Agent Loopã€Tool Callingã€è®°å¿†ç®¡ç†ã€ä¸Šä¸‹æ–‡ç®¡ç†ç­‰å…³é”®æŠ€æœ¯ã€‚"
tags: 
  - OpenClaw
  - ClawdBot
  - AI Agent
  - LLM
  - CLI
  - æºç åˆ†æ
categories:
  - Agent
  - AI
---

# ğŸ¦ OpenClaw (åŸClawdBot) å¼€æºé¡¹ç›®æ·±åº¦åˆ†æ

> æœ¬æ–‡æ¡£æ˜¯å¯¹ OpenClaw (åŸ ClawdBot) é¡¹ç›®çš„å…¨é¢æŠ€æœ¯åˆ†æï¼Œæ—¨åœ¨å¸®åŠ©å¼€å‘è€…æ·±å…¥ç†è§£å…¶å®ç°åŸç†ã€‚

| é¡¹ç›®ä¿¡æ¯ | è¯¦æƒ… |
|---------|------|
| **GitHub ä»“åº“** | [https://github.com/openclaw/openclaw](https://github.com/openclaw/openclaw) |
| **å½“å‰ç‰ˆæœ¬** | `v2026.1.30` |
| **è®¸å¯è¯** | MIT |
| **æœ€æ–° Commit** | `476f367cf16081acd144048ee61198e58d15df21` |
| **å†å²åç§°** | Clawdbot â†’ Moltbot â†’ **OpenClaw** |

> **ğŸ“ é¡¹ç›®æ›´åå†å²ï¼š**
> - **Clawdbot** (2025.11.25 - 2026.1.27) â€” æœ€åˆçš„é¡¹ç›®åç§°
> - **Moltbot** (2026.1.27 - ?) â€” ç¬¬ä¸€æ¬¡æ›´åï¼Œå¯“æ„"èœ•å˜"
> - **OpenClaw** (å½“å‰) â€” æœ€ç»ˆæ›´åä¸ºå¼€æºç‰ˆæœ¬åç§°

## ç›®å½•

- [ä¸€ã€é¡¹ç›®æ¦‚è¿°](#ä¸€é¡¹ç›®æ¦‚è¿°)
  - [1.1 æ ¸å¿ƒä»·å€¼](#11-æ ¸å¿ƒä»·å€¼)
  - [1.2 æŠ€æœ¯æ ˆ](#12-æŠ€æœ¯æ ˆ)
- [äºŒã€æŠ€æœ¯æ¶æ„å…¨æ™¯](#äºŒæŠ€æœ¯æ¶æ„å…¨æ™¯)
  - [2.1 é¡¹ç›®ç›®å½•ç»“æ„](#21-é¡¹ç›®ç›®å½•ç»“æ„)
- [ä¸‰ã€ç¨‹åºå¯åŠ¨ä¸å…¥å£é“¾è·¯](#ä¸‰ç¨‹åºå¯åŠ¨ä¸å…¥å£é“¾è·¯)
  - [3.1 å¯åŠ¨æµç¨‹æ€»è§ˆ](#31-å¯åŠ¨æµç¨‹æ€»è§ˆ)
  - [3.2 å…¥å£å±‚åˆå§‹åŒ–](#32-å…¥å£å±‚åˆå§‹åŒ–)
  - [3.3 CLI å‘½ä»¤è·¯ç”±](#33-cli-å‘½ä»¤è·¯ç”±)
  - [3.4 Gateway Server å¯åŠ¨](#34-gateway-server-å¯åŠ¨)
  - [3.5 æ¶ˆæ¯åˆ°è¾¾ä¸ Agent è°ƒç”¨](#35-æ¶ˆæ¯åˆ°è¾¾ä¸-agent-è°ƒç”¨)
- [å››ã€Agent æ ¸å¿ƒå®ç°](#å››agent-æ ¸å¿ƒå®ç°)
  - [4.1 Agent æ¶æ„æ€»è§ˆ](#41-agent-æ¶æ„æ€»è§ˆ)
  - [4.2 Agent è¿è¡Œä¸»å…¥å£](#42-agent-è¿è¡Œä¸»å…¥å£)
  - [4.3 Agent ä¼šè¯åˆ›å»ºä¸æ‰§è¡Œ](#43-agent-ä¼šè¯åˆ›å»ºä¸æ‰§è¡Œ)
  - [4.4 ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†](#44-ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†)
  - [4.5 äº‹ä»¶é©±åŠ¨çš„æ¶ˆæ¯å¤„ç†](#45-äº‹ä»¶é©±åŠ¨çš„æ¶ˆæ¯å¤„ç†)
  - [4.6 å·¥å…·è°ƒç”¨å¤„ç†](#46-å·¥å…·è°ƒç”¨å¤„ç†)
  - [4.7 å·¥å…·ç³»ç»Ÿ](#47-å·¥å…·ç³»ç»Ÿ)
  - [4.8 Agent å¾ªç¯æµç¨‹å›¾](#48-agent-å¾ªç¯æµç¨‹å›¾)
  - [4.9 æ ¸å¿ƒä¾èµ–åº“](#49-æ ¸å¿ƒä¾èµ–åº“)
- [äº”ã€ç³»ç»Ÿæç¤ºè¯å·¥ç¨‹](#äº”ç³»ç»Ÿæç¤ºè¯å·¥ç¨‹)
  - [5.1 ç³»ç»Ÿæç¤ºè¯æ•´ä½“ç»“æ„](#51-ç³»ç»Ÿæç¤ºè¯æ•´ä½“ç»“æ„)
  - [5.2 æ ¸å¿ƒæ¨¡å—è¯¦è§£](#52-æ ¸å¿ƒæ¨¡å—è¯¦è§£)
  - [5.3 æ¨¡å—åŒ–è®¾è®¡æ€»ç»“](#53-æ¨¡å—åŒ–è®¾è®¡æ€»ç»“)
- [å…­ã€Skills æ£€ç´¢ç³»ç»Ÿ](#å…­skills-æ£€ç´¢ç³»ç»Ÿ)
  - [6.1 Skills ç›®å½•ç»“æ„](#61-skills-ç›®å½•ç»“æ„)
  - [6.2 SKILL.md æ–‡ä»¶æ ¼å¼](#62-skillmd-æ–‡ä»¶æ ¼å¼)
  - [6.3 Skills åŠ è½½æµç¨‹](#63-skills-åŠ è½½æµç¨‹)
  - [6.4 Skills èµ„æ ¼æ£€æŸ¥ (Eligibility)](#64-skills-èµ„æ ¼æ£€æŸ¥-eligibility)
  - [6.5 Skills æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºè¯](#65-skills-æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºè¯)
  - [6.6 Skills æ£€ç´¢ç­–ç•¥](#66-skills-æ£€ç´¢ç­–ç•¥)
  - [6.7 Skills æ–‡ä»¶ç›‘è§†ä¸çƒ­åˆ·æ–°](#67-skills-æ–‡ä»¶ç›‘è§†ä¸çƒ­åˆ·æ–°)
- [ä¸ƒã€è®°å¿†ç®¡ç†ç³»ç»Ÿ](#ä¸ƒè®°å¿†ç®¡ç†ç³»ç»Ÿ)
  - [7.1 ä¸ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†çš„åŒºåˆ«](#71-ä¸ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†çš„åŒºåˆ«)
  - [7.2 æ¶æ„æ€»è§ˆ](#72-æ¶æ„æ€»è§ˆ)
  - [7.3 è®°å¿†å­˜å‚¨æ¥æº](#73-è®°å¿†å­˜å‚¨æ¥æº)
  - [7.4 è®°å¿†æ–‡ä»¶ç»“æ„ä¸ç”Ÿæˆæœºåˆ¶](#74-è®°å¿†æ–‡ä»¶ç»“æ„ä¸ç”Ÿæˆæœºåˆ¶)
  - [7.5 å‘é‡åµŒå…¥ä¸æ£€ç´¢](#75-å‘é‡åµŒå…¥ä¸æ£€ç´¢)
  - [7.6 æ··åˆæœç´¢ç­–ç•¥](#76-æ··åˆæœç´¢ç­–ç•¥)
  - [7.7 è®°å¿†æ–‡ä»¶æŸ¥çœ‹æ—¶æœº](#77-è®°å¿†æ–‡ä»¶æŸ¥çœ‹æ—¶æœº)
  - [7.8 è®°å¿†å·¥å…·](#78-è®°å¿†å·¥å…·)
  - [7.9 é…ç½®å‚æ•°](#79-é…ç½®å‚æ•°)
- [å…«ã€è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ](#å…«è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ)
  - [8.1 æ’ä»¶åŒ–æ¶æ„](#81-æ’ä»¶åŒ–æ¶æ„)
  - [8.2 äº‹ä»¶é©±åŠ¨è®¾è®¡](#82-äº‹ä»¶é©±åŠ¨è®¾è®¡)
  - [8.3 å¹¶å‘æ§åˆ¶](#83-å¹¶å‘æ§åˆ¶)
  - [8.4 æ ¸å¿ƒè®¾è®¡äº®ç‚¹æ€»ç»“](#84-æ ¸å¿ƒè®¾è®¡äº®ç‚¹æ€»ç»“)
- [ä¹ã€æ€»ç»“](#ä¹æ€»ç»“)
  - [9.1 Agent ç³»ç»Ÿå¼€å‘çš„æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ](#91-agent-ç³»ç»Ÿå¼€å‘çš„æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ)
  - [9.2 OpenClaw çš„æŠ€æœ¯æ¶æ„æ€»ç»“](#92-openclaw-çš„æŠ€æœ¯æ¶æ„æ€»ç»“)
  - [9.3 æ„å»ºç”Ÿäº§çº§ Agent ç³»ç»Ÿçš„å…³é”®è€ƒé‡](#93-æ„å»ºç”Ÿäº§çº§-agent-ç³»ç»Ÿçš„å…³é”®è€ƒé‡)
  - [9.4 å­¦ä¹ ä»·å€¼ä¸å®è·µå»ºè®®](#94-å­¦ä¹ ä»·å€¼ä¸å®è·µå»ºè®®)

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

**OpenClaw** æ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§çš„**ä¸ªäºº AI åŠ©æ‰‹å¹³å°**ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨è‡ªå·±çš„è®¾å¤‡ä¸Šè¿è¡Œ AI åŠ©æ‰‹ï¼Œå¹¶é€šè¿‡å¤šç§å³æ—¶é€šè®¯æ¸ é“ï¼ˆWhatsAppã€Telegramã€Discordã€Slack ç­‰ï¼‰ä¸ä¹‹äº¤äº’ã€‚

### 1.1 æ ¸å¿ƒä»·å€¼

| ç‰¹æ€§ | è¯´æ˜ |
|------|------|
| **æœ¬åœ°ä¼˜å…ˆ** | è¿è¡Œåœ¨ç”¨æˆ·è‡ªå·±çš„è®¾å¤‡ä¸Šï¼Œæ•°æ®ä¸ç¦»å¼€æœ¬åœ° |
| **å¤šæ¸ é“ç»Ÿä¸€** | ä¸€ä¸ª AI åŠ©æ‰‹ï¼Œå¤šä¸ªèŠå¤©å¹³å° |
| **å¯æ‰©å±•æ€§å¼º** | æ’ä»¶åŒ–æ¶æ„ï¼Œæ˜“äºæ‰©å±•æ–°åŠŸèƒ½ |
| **ç±»å‹å®‰å…¨** | TypeScript + Zod ä¿è¯ä»£ç è´¨é‡ |

### 1.2 æŠ€æœ¯æ ˆ

- **è¯­è¨€**: TypeScript (ESM)
- **è¿è¡Œæ—¶**: Node.js 22+ / Bun
- **åŒ…ç®¡ç†**: pnpm
- **æ„å»ºå·¥å…·**: TypeScript Compiler
- **æµ‹è¯•æ¡†æ¶**: Vitest
- **ä»£ç è§„èŒƒ**: Oxlint + Oxfmt

---

## äºŒã€æŠ€æœ¯æ¶æ„å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·äº¤äº’å±‚                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Telegram   â”‚   WhatsApp  â”‚   Discord   â”‚    Slack    â”‚   å…¶ä»–æ¸ é“...      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Gateway Server (ç½‘å…³æœåŠ¡å™¨)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  WebSocket  â”‚  â”‚   HTTP API  â”‚  â”‚ Cron è°ƒåº¦   â”‚  â”‚  Hooks ç³»ç»Ÿ     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Agent ä»£ç†ç³»ç»Ÿ                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä¼šè¯ç®¡ç†    â”‚  â”‚  å·¥å…·æ‰§è¡Œ   â”‚  â”‚  æ¨¡å‹åˆ‡æ¢   â”‚  â”‚  è®°å¿†/ä¸Šä¸‹æ–‡     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            æ¨¡å‹æä¾›å•†                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Anthropic â”‚  â”‚  OpenAI   â”‚  â”‚  Google   â”‚  â”‚  Ollama   â”‚  â”‚  å…¶ä»–   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.1 é¡¹ç›®ç›®å½•ç»“æ„

```
openclaw/
â”œâ”€â”€ src/                    # æ ¸å¿ƒæºä»£ç 
â”‚   â”œâ”€â”€ cli/               # CLI å‘½ä»¤å®ç°
â”‚   â”œâ”€â”€ commands/          # å­å‘½ä»¤æ¨¡å—
â”‚   â”œâ”€â”€ gateway/           # ç½‘å…³æœåŠ¡å™¨
â”‚   â”œâ”€â”€ agents/            # AI Agent ç³»ç»Ÿ
â”‚   â”œâ”€â”€ channels/          # æ¸ é“æŠ½è±¡å±‚
â”‚   â”œâ”€â”€ telegram/          # Telegram æ¸ é“
â”‚   â”œâ”€â”€ discord/           # Discord æ¸ é“
â”‚   â”œâ”€â”€ slack/             # Slack æ¸ é“
â”‚   â”œâ”€â”€ signal/            # Signal æ¸ é“
â”‚   â”œâ”€â”€ imessage/          # iMessage æ¸ é“
â”‚   â”œâ”€â”€ plugins/           # æ’ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ infra/             # åŸºç¡€è®¾æ–½
â”‚   â””â”€â”€ media/             # åª’ä½“å¤„ç†
â”œâ”€â”€ extensions/            # æ‰©å±•æ’ä»¶
â”‚   â”œâ”€â”€ msteams/          # Microsoft Teams
â”‚   â”œâ”€â”€ matrix/           # Matrix åè®®
â”‚   â”œâ”€â”€ voice-call/       # è¯­éŸ³é€šè¯
â”‚   â””â”€â”€ memory-lancedb/   # LanceDB è®°å¿†
â”œâ”€â”€ skills/               # å†…ç½® Skills (52+)
â”œâ”€â”€ apps/                 # åŸç”Ÿåº”ç”¨
â”‚   â”œâ”€â”€ ios/             # iOS App
â”‚   â”œâ”€â”€ macos/           # macOS App
â”‚   â””â”€â”€ android/         # Android App
â”œâ”€â”€ docs/                 # æ–‡æ¡£
â”œâ”€â”€ ui/                   # Web UI
â””â”€â”€ test/                 # æµ‹è¯•æ–‡ä»¶
```

---

## ä¸‰ã€ç¨‹åºå¯åŠ¨ä¸å…¥å£é“¾è·¯

æœ¬ç« èšç„¦äºå›ç­”ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š**å½“ç”¨æˆ·è¿è¡Œ `openclaw gateway run` åï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**

æˆ‘ä»¬å°†æŒ‰ç…§ä»£ç å®é™…æ‰§è¡Œé¡ºåºï¼Œè¿½è¸ªä»å‘½ä»¤è¡Œè¾“å…¥åˆ° Agent æ¥æ”¶æ¶ˆæ¯çš„å®Œæ•´é“¾è·¯ã€‚

### 3.1 å¯åŠ¨æµç¨‹æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     $ openclaw gateway run --port 18789                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘  å…¥å£å±‚ (src/entry.ts)                                                     â”‚
â”‚     â€¢ è®¾ç½®è¿›ç¨‹æ ‡é¢˜ process.title = "openclaw"                                â”‚
â”‚     â€¢ ç¯å¢ƒå˜é‡è§„èŒƒåŒ– normalizeEnv()                                          â”‚
â”‚     â€¢ å®éªŒæ€§è­¦å‘ŠæŠ‘åˆ¶                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¡ CLI è·¯ç”± (src/cli/run-main.ts)                                           â”‚
â”‚     â€¢ åŠ è½½ .env é…ç½®                                                         â”‚
â”‚     â€¢ è¿è¡Œæ—¶ç‰ˆæœ¬æ£€æŸ¥ assertSupportedRuntime()                                â”‚
â”‚     â€¢ æ„å»ºå‘½ä»¤ç¨‹åº buildProgram()                                            â”‚
â”‚     â€¢ è·¯ç”±åˆ° gateway run å­å‘½ä»¤                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¢ Gateway å¯åŠ¨ (src/gateway/server.impl.ts)                                â”‚
â”‚     â€¢ åˆ›å»º HTTP Server + WebSocket Server                                    â”‚
â”‚     â€¢ åˆå§‹åŒ– NodeRegistryï¼ˆè®¾å¤‡èŠ‚ç‚¹ç®¡ç†ï¼‰                                     â”‚
â”‚     â€¢ åˆå§‹åŒ– ChannelManagerï¼ˆæ¶ˆæ¯æ¸ é“ç®¡ç†ï¼‰                                   â”‚
â”‚     â€¢ å¯åŠ¨ CronServiceï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰                                           â”‚
â”‚     â€¢ ç»‘å®š WebSocket å¤„ç†å™¨                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘£ æ¸ é“è¿æ¥ (Telegram/WhatsApp/Discord/...)                                 â”‚
â”‚     â€¢ ChannelManager å¯åŠ¨é…ç½®çš„æ¸ é“                                          â”‚
â”‚     â€¢ å„æ¸ é“å»ºç«‹ä¸å¹³å°çš„è¿æ¥ï¼ˆBot API / Web Socket ç­‰ï¼‰                       â”‚
â”‚     â€¢ å¼€å§‹ç›‘å¬æ¶ˆæ¯                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                        â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¼ â”€ â”€ â”€ â”€ â”€ â”€ â”€  ç”¨æˆ·å‘é€æ¶ˆæ¯
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‘¤ æ¶ˆæ¯åˆ°è¾¾ â†’ Agent è°ƒç”¨                                                     â”‚
â”‚     â€¢ æ¸ é“æ¥æ”¶æ¶ˆæ¯ï¼Œè·¯ç”±åˆ° Gateway                                           â”‚
â”‚     â€¢ Gateway è°ƒç”¨ runEmbeddedPiAgent()                                      â”‚
â”‚     â€¢ è¿›å…¥ Agent æ ¸å¿ƒå¾ªç¯ï¼ˆç¬¬å››ç« è¯¦è§£ï¼‰                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å…¥å£å±‚åˆå§‹åŒ–

**æ–‡ä»¶**: `src/entry.ts`

è¿™æ˜¯æ•´ä¸ªç¨‹åºçš„ç¬¬ä¸€ä¸ªæ‰§è¡Œç‚¹ï¼Œè´Ÿè´£ç¯å¢ƒå‡†å¤‡ï¼š

```typescript
#!/usr/bin/env node
import { spawn } from "node:child_process";
import process from "node:process";
import { applyCliProfileEnv, parseCliProfileArgs } from "./cli/profile.js";
import { isTruthyEnvValue, normalizeEnv } from "./infra/env.js";
import { installProcessWarningFilter } from "./infra/warnings.js";

// è®¾ç½®è¿›ç¨‹åç§°ï¼ˆä¾¿äº ps/top è¯†åˆ«ï¼‰
process.title = "openclaw";

// è¿‡æ»¤ Node.js å®éªŒæ€§åŠŸèƒ½è­¦å‘Š
installProcessWarningFilter();

// è§„èŒƒåŒ–ç¯å¢ƒå˜é‡ï¼ˆå¤„ç†å¤§å°å†™ã€åˆ«åç­‰ï¼‰
normalizeEnv();
```

**å…¥å£å±‚åšäº†ä»€ä¹ˆï¼Ÿ**

| æ­¥éª¤ | å‡½æ•° | ä½œç”¨ |
|------|------|------|
| 1 | `process.title = "openclaw"` | è®¾ç½®è¿›ç¨‹åï¼Œä¾¿äºç³»ç»Ÿç›‘æ§ |
| 2 | `installProcessWarningFilter()` | æŠ‘åˆ¶ Node.js å®éªŒæ€§ API è­¦å‘Š |
| 3 | `normalizeEnv()` | ç»Ÿä¸€ç¯å¢ƒå˜é‡æ ¼å¼ |
| 4 | `parseCliProfileArgs()` | è§£æ `--profile` å‚æ•° |

### 3.3 CLI å‘½ä»¤è·¯ç”±

**æ–‡ä»¶**: `src/cli/run-main.ts`

å…¥å£å±‚å®Œæˆåï¼Œè¿›å…¥ CLI å±‚è¿›è¡Œå‘½ä»¤è§£æå’Œè·¯ç”±ï¼š

```typescript
export async function runCli(argv: string[] = process.argv) {
  // 1. Windows ç‰¹æ®Šå¤„ç†
  const normalizedArgv = stripWindowsNodeExec(argv);
  
  // 2. åŠ è½½ .env æ–‡ä»¶
  loadDotEnv({ quiet: true });
  normalizeEnv();
  
  // 3. ç¡®ä¿ openclaw åœ¨ PATH ä¸­
  ensureOpenClawCliOnPath();

  // 4. è¿è¡Œæ—¶ç‰ˆæœ¬æ£€æŸ¥ï¼ˆNode.js 22+ï¼‰
  assertSupportedRuntime();

  // 5. å°è¯•å¿«é€Ÿè·¯ç”±ï¼ˆæŸäº›å‘½ä»¤ä¸éœ€è¦å®Œæ•´åˆå§‹åŒ–ï¼‰
  if (await tryRouteCli(normalizedArgv)) {
    return;
  }

  // 6. æ•è·æ§åˆ¶å°è¾“å‡ºåˆ°ç»“æ„åŒ–æ—¥å¿—
  enableConsoleCapture();

  // 7. æ„å»ºå‘½ä»¤ç¨‹åºï¼ˆå»¶è¿ŸåŠ è½½ï¼‰
  const { buildProgram } = await import("./program.js");
  const program = buildProgram();
  
  // 8. è§£æå‘½ä»¤å¹¶æ‰§è¡Œ
  await program.parseAsync(normalizedArgv);
}
```

**è®¾è®¡äº®ç‚¹**ï¼š

1. **å»¶è¿ŸåŠ è½½**: å­å‘½ä»¤æŒ‰éœ€ `import()`ï¼ŒåŠ å¿«å¯åŠ¨é€Ÿåº¦
2. **è·¨å¹³å°å…¼å®¹**: Windows å‚æ•°å¤„ç†æœ‰ç‰¹æ®Šé€»è¾‘
3. **å¿«é€Ÿè·¯ç”±**: ç®€å•å‘½ä»¤æ— éœ€åŠ è½½å®Œæ•´æ¡†æ¶

å½“ç”¨æˆ·æ‰§è¡Œ `openclaw gateway run` æ—¶ï¼ŒCLI è·¯ç”±åˆ° `src/commands/gateway/run.ts`ã€‚

### 3.4 Gateway Server å¯åŠ¨

**æ–‡ä»¶**: `src/gateway/server.impl.ts`

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„**æ§åˆ¶ä¸­å¿ƒ**ï¼Œ`gateway run` å‘½ä»¤æœ€ç»ˆä¼šè°ƒç”¨ï¼š

```typescript
export async function startGatewayServer(
  port = 18789,
  opts: GatewayServerOptions = {},
): Promise<GatewayServer> {
  // 1. åˆ›å»ºæ ¸å¿ƒè¿è¡Œæ—¶çŠ¶æ€
  const {
    canvasHost,
    httpServer,
    wss,            // WebSocket Server
    clients,        // è¿æ¥çš„å®¢æˆ·ç«¯
    broadcast,      // å¹¿æ’­å‡½æ•°
  } = await createGatewayRuntimeState({
    port,
    hostname: opts.hostname,
    ...
  });
  
  // 2. èŠ‚ç‚¹æ³¨å†Œè¡¨ï¼ˆç®¡ç†è¿æ¥çš„è®¾å¤‡ï¼šæ‰‹æœºã€å…¶ä»–ç½‘å…³ï¼‰
  const nodeRegistry = new NodeRegistry();
  
  // 3. Cron æœåŠ¡ï¼ˆå®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼‰
  let cronState = buildGatewayCronService({
    config: cfg,
    onTrigger: (job) => handleCronTrigger(job),
    ...
  });
  
  // 4. æ¸ é“ç®¡ç†å™¨ï¼ˆç®¡ç†æ‰€æœ‰æ¶ˆæ¯æ¸ é“ï¼‰
  const channelManager = createChannelManager({
    config: cfg,
    onMessage: (msg) => routeMessageToAgent(msg),
    ...
  });
  
  // 5. ç»‘å®š WebSocket å¤„ç†å™¨
  attachGatewayWsHandlers({
    wss,
    clients,
    nodeRegistry,
    channelManager,
    ...
  });
  
  // 6. å¯åŠ¨æ¸ é“è¿æ¥
  await channelManager.startAll();
  
  return { httpServer, wss, channelManager, ... };
}
```

**Gateway æ ¸å¿ƒç»„ä»¶**ï¼š

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `NodeRegistry` | `src/gateway/node-registry.ts` | ç®¡ç†è¿æ¥çš„è®¾å¤‡èŠ‚ç‚¹ |
| `ChannelManager` | `src/channels/manager.ts` | å¯åŠ¨/åœæ­¢/ç®¡ç†æ¶ˆæ¯æ¸ é“ |
| `CronService` | `src/gateway/cron.ts` | å®šæ—¶ä»»åŠ¡è°ƒåº¦ |
| `WebSocket Server` | `src/gateway/ws-handlers.ts` | å®æ—¶åŒå‘é€šä¿¡ |
| `ExecApprovalManager` | `src/gateway/exec-approval.ts` | å‘½ä»¤æ‰§è¡Œå®¡æ‰¹ |

### 3.5 æ¶ˆæ¯åˆ°è¾¾ä¸ Agent è°ƒç”¨

å½“ Gateway å¯åŠ¨å®Œæˆåï¼Œå„æ¸ é“å¼€å§‹ç›‘å¬æ¶ˆæ¯ã€‚ä»¥ Telegram ä¸ºä¾‹ï¼š

**æ¶ˆæ¯æµè½¬è·¯å¾„**ï¼š

```
ç”¨æˆ·åœ¨ Telegram å‘é€æ¶ˆæ¯
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Telegram Bot API (Grammy)              â”‚
â”‚  src/telegram/bot.ts                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ bot.on("message", handler)
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯å¤„ç†ä¸­é—´ä»¶                          â”‚
â”‚  â€¢ èŠ‚æµ (apiThrottler)                  â”‚
â”‚  â€¢ ä¸²è¡ŒåŒ– (sequentialize)               â”‚
â”‚  â€¢ æƒé™æ£€æŸ¥ (allowlist)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChannelManager.routeMessage()          â”‚
â”‚  ç»Ÿä¸€æ¶ˆæ¯æ ¼å¼ï¼Œè·¯ç”±åˆ° Agent              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  runEmbeddedPiAgent()                   â”‚
â”‚  src/agents/pi-embedded-runner/run.ts   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  è¿›å…¥ Agent æ ¸å¿ƒå¾ªç¯ï¼ˆç¬¬å››ç« è¯¦è§£ï¼‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ä»£ç ç‰‡æ®µ**ï¼ˆTelegram æ¶ˆæ¯å¤„ç†ï¼‰ï¼š

```typescript
// src/telegram/bot.ts
export function createTelegramBot(opts: TelegramBotOptions) {
  const bot = new Bot(opts.token);
  
  // èŠ‚æµï¼šé¿å…è§¦å‘ Telegram API é™åˆ¶
  bot.api.config.use(apiThrottler());
  
  // ä¸²è¡ŒåŒ–ï¼šåŒä¸€èŠå¤©çš„æ¶ˆæ¯æŒ‰é¡ºåºå¤„ç†
  bot.use(sequentialize(getTelegramSequentialKey));
  
  // æ¶ˆæ¯å¤„ç†
  bot.on("message:text", async (ctx) => {
    const message = ctx.message.text;
    const chatId = ctx.chat.id;
    
    // è·¯ç”±åˆ° Agent
    await routeToAgent({
      channel: "telegram",
      chatId,
      message,
      replyFn: (text) => ctx.reply(text),
    });
  });
  
  return bot;
}
```

**æ¸ é“æŠ½è±¡æœºåˆ¶**ï¼š

æ‰€æœ‰æ¸ é“éƒ½å®ç°ç»Ÿä¸€çš„æ¥å£ï¼Œä½¿å¾— Agent æ— éœ€å…³å¿ƒæ¶ˆæ¯æ¥æºï¼š

```typescript
// ç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼
interface ChannelMessage {
  channel: ChatChannelId;     // "telegram" | "whatsapp" | ...
  chatId: string;             // èŠå¤©æ ‡è¯†
  userId: string;             // ç”¨æˆ·æ ‡è¯†
  message: string;            // æ¶ˆæ¯å†…å®¹
  replyFn: (text: string) => Promise<void>;  // å›å¤å‡½æ•°
}
```

---

**å°ç»“**ï¼šæœ¬ç« æ¢³ç†äº†ä» `openclaw gateway run` åˆ°æ¶ˆæ¯è¿›å…¥ Agent çš„å®Œæ•´é“¾è·¯ã€‚ç†è§£äº†è¿™æ¡ä¸»çº¿åï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥ Agent å†…éƒ¨ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å¤„ç†æ¶ˆæ¯ã€è°ƒç”¨å·¥å…·ã€ç”Ÿæˆå›å¤çš„ã€‚

---

## å››ã€Agent æ ¸å¿ƒå®ç°

OpenClaw æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª **AI Agent ç³»ç»Ÿ**ï¼Œå…¶æ ¸å¿ƒåœ¨äºå®ç°äº†ä¸€ä¸ªå®Œæ•´çš„ Agent å¾ªç¯ã€‚è¿™ä¸€èŠ‚æˆ‘ä»¬æ·±å…¥åˆ†æ Agent çš„æ ¸å¿ƒå®ç°æœºåˆ¶ã€‚

### 4.1 Agent æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æ¶ˆæ¯è¾“å…¥                                     â”‚
â”‚                    (Telegram/WhatsApp/CLI/...)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    runEmbeddedPiAgent()                                  â”‚
â”‚               src/agents/pi-embedded-runner/run.ts                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ ä¼šè¯é˜Ÿåˆ—ç®¡ç† (sessionLane / globalLane)                       â”‚    â”‚
â”‚  â”‚  â€¢ æ¨¡å‹è§£æ & API Key ç®¡ç†                                       â”‚    â”‚
â”‚  â”‚  â€¢ ä¸Šä¸‹æ–‡æº¢å‡ºå¤„ç† â†’ è‡ªåŠ¨å‹ç¼©                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    runEmbeddedAttempt()                                  â”‚
â”‚            src/agents/pi-embedded-runner/run/attempt.ts                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â€¢ Skills åŠ è½½                                                   â”‚    â”‚
â”‚  â”‚  â€¢ Bootstrap æ–‡ä»¶æ³¨å…¥                                            â”‚    â”‚
â”‚  â”‚  â€¢ å·¥å…·åˆ›å»º                                                      â”‚    â”‚
â”‚  â”‚  â€¢ ç³»ç»Ÿæç¤ºè¯æ„å»º                                                â”‚    â”‚
â”‚  â”‚  â€¢ createAgentSession() - åˆ›å»º Agent ä¼šè¯                        â”‚    â”‚
â”‚  â”‚  â€¢ session.prompt() - æ‰§è¡Œ LLM è°ƒç”¨                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              subscribeEmbeddedPiSession() - äº‹ä»¶è®¢é˜…                     â”‚
â”‚                src/agents/pi-embedded-subscribe.ts                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  äº‹ä»¶ç±»å‹:                                                       â”‚    â”‚
â”‚  â”‚  â€¢ message_start/update/end   - æ¶ˆæ¯æµå¤„ç†                       â”‚    â”‚
â”‚  â”‚  â€¢ tool_execution_start/update/end - å·¥å…·è°ƒç”¨å¤„ç†                â”‚    â”‚
â”‚  â”‚  â€¢ agent_start/end            - Agent ç”Ÿå‘½å‘¨æœŸ                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       LLM æ¨¡å‹è°ƒç”¨å±‚                                     â”‚
â”‚               @mariozechner/pi-ai (streamSimple)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  æ”¯æŒçš„æä¾›å•†:                                                   â”‚    â”‚
â”‚  â”‚  â€¢ Anthropic (Claude)                                            â”‚    â”‚
â”‚  â”‚  â€¢ OpenAI (GPT-4/4o)                                             â”‚    â”‚
â”‚  â”‚  â€¢ Google (Gemini)                                               â”‚    â”‚
â”‚  â”‚  â€¢ Ollama (æœ¬åœ°æ¨¡å‹)                                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 Agent è¿è¡Œä¸»å…¥å£

**æ–‡ä»¶**: `src/agents/pi-embedded-runner/run.ts`

è¿™æ˜¯ Agent è¿è¡Œçš„ä¸»å…¥å£å‡½æ•°ï¼š

```typescript
export async function runEmbeddedPiAgent(
  params: RunEmbeddedPiAgentParams,
): Promise<EmbeddedPiRunResult> {
  // 1. åˆ›å»ºä¼šè¯é˜Ÿåˆ—ï¼ˆç¡®ä¿åŒä¸€ä¼šè¯çš„æ¶ˆæ¯ä¸²è¡Œå¤„ç†ï¼‰
  const sessionLane = resolveSessionLane(params.sessionKey?.trim() || params.sessionId);
  const globalLane = resolveGlobalLane(params.lane);
  
  return enqueueSession(() =>
    enqueueGlobal(async () => {
      // 2. è§£ææ¨¡å‹
      const { model, authStorage, modelRegistry } = resolveModel(
        provider, modelId, agentDir, params.config
      );
      
      // 3. æ‰§è¡Œå•æ¬¡ Agent è¿è¡Œ
      const attempt = await runEmbeddedAttempt({...});
      
      // 4. å¤„ç†ä¸Šä¸‹æ–‡æº¢å‡º â†’ è‡ªåŠ¨å‹ç¼©åé‡è¯•
      if (isContextOverflowError(errorText)) {
        await compactEmbeddedPiSessionDirect({...});
        continue;  // å‹ç¼©åé‡è¯•
      }
      
      // 5. è¿”å›ç»“æœ
      return { payloads, meta };
    })
  );
}
```

**å…³é”®è®¾è®¡ç‚¹**:

| æœºåˆ¶ | è¯´æ˜ |
|------|------|
| **é˜Ÿåˆ—ä¸²è¡ŒåŒ–** | åŒä¸€ä¼šè¯çš„æ¶ˆæ¯æŒ‰åºå¤„ç†ï¼Œé¿å…å¹¶å‘å†²çª |
| **ä¸Šä¸‹æ–‡æº¢å‡ºè‡ªåŠ¨å‹ç¼©** | æ£€æµ‹åˆ°æº¢å‡ºæ—¶è‡ªåŠ¨å‹ç¼©å†å²ï¼Œç„¶åé‡è¯• |

### 4.3 Agent ä¼šè¯åˆ›å»ºä¸æ‰§è¡Œ

**æ–‡ä»¶**: `src/agents/pi-embedded-runner/run/attempt.ts`

è¿™æ˜¯å•æ¬¡ Agent æ‰§è¡Œçš„æ ¸å¿ƒé€»è¾‘ï¼š

```typescript
export async function runEmbeddedAttempt(
  params: EmbeddedRunAttemptParams,
): Promise<EmbeddedRunAttemptResult> {
  // 1. åŠ è½½ Skills
  const skillEntries = loadWorkspaceSkillEntries(effectiveWorkspace);
  const skillsPrompt = resolveSkillsPromptForRun({...});
  
  // 2. åŠ è½½ Bootstrap ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼ˆå¦‚ AGENTS.mdï¼‰
  const { bootstrapFiles, contextFiles } = await resolveBootstrapContextForRun({...});
  
  // 3. åˆ›å»ºå·¥å…·é›†
  const toolsRaw = createOpenClawCodingTools({
    messageProvider: params.messageChannel,
    sessionKey: params.sessionKey,
    workspaceDir: effectiveWorkspace,
    config: params.config,
    abortSignal: runAbortController.signal,
  });
  
  // 4. æ„å»ºç³»ç»Ÿæç¤ºè¯
  const systemPromptText = buildEmbeddedSystemPrompt({
    workspaceDir: effectiveWorkspace,
    toolNames: tools.map(t => t.name),
    skillsPrompt,
    contextFiles,
    runtimeInfo: {...},
  });
  
  // 5. åˆ›å»º Agent ä¼šè¯ï¼ˆæ ¸å¿ƒï¼ï¼‰
  const { session } = await createAgentSession({
    cwd: resolvedWorkspace,
    agentDir,
    model: params.model,
    tools: builtInTools,
    customTools: allCustomTools,
    sessionManager,
  });
  
  // 6. è®¾ç½®æµå¼è°ƒç”¨å‡½æ•°
  session.agent.streamFn = streamSimple;
  
  // 7. è®¢é˜…ä¼šè¯äº‹ä»¶
  const subscription = subscribeEmbeddedPiSession({
    session: activeSession,
    runId: params.runId,
    onToolResult: params.onToolResult,
    onBlockReply: params.onBlockReply,
    onAgentEvent: params.onAgentEvent,
  });
  
  // 8. æ‰§è¡Œ promptï¼ˆè°ƒç”¨ LLMï¼‰â€”â€” è¿™æ˜¯æ ¸å¿ƒï¼
  await activeSession.prompt(effectivePrompt);
  
  // 9. è¿”å›ç»“æœ
  return {
    assistantTexts,
    toolMetas,
    lastAssistant,
  };
}
```

### 4.4 ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†

Agent ä¼šè¯åˆ›å»ºåï¼Œä¸Šä¸‹æ–‡ç®¡ç†æ˜¯ä¿è¯é•¿å¯¹è¯æ­£å¸¸è¿è¡Œçš„æ ¸å¿ƒæœºåˆ¶ã€‚

#### 4.4.1 æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†æ¶æ„                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ä¼šè¯å­˜å‚¨å±‚       â”‚   â”‚   Token ç®¡ç†å±‚     â”‚   â”‚    å‹ç¼©ç­–ç•¥å±‚          â”‚
â”‚  (.jsonl æ–‡ä»¶)    â”‚   â”‚  (ä¼°ç®—ä¸é™åˆ¶)      â”‚   â”‚  (å¤šçº§è£å‰ª)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â”‚                          â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          â”‚           â–¼                         â–¼
        â”‚                          â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                          â”‚   â”‚ Context      â”‚     â”‚ Compaction       â”‚
        â”‚                          â”‚   â”‚ Pruning      â”‚     â”‚ Safeguard        â”‚
        â”‚                          â”‚   â”‚ (è½¯è£å‰ª)     â”‚     â”‚ (æ‘˜è¦ç”Ÿæˆ)        â”‚
        â”‚                          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Memory Search    â”‚   â”‚  History Limit    â”‚
â”‚  (è¯­ä¹‰æ£€ç´¢)       â”‚   â”‚  (è½®æ¬¡é™åˆ¶)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.4.2 ä¼šè¯å­˜å‚¨æœºåˆ¶

**å­˜å‚¨æ ¼å¼**: JSON Lines (`.jsonl`)

**å­˜å‚¨è·¯å¾„**: `~/.openclaw/sessions/{sessionId}.jsonl`

æ¯è¡Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ JSON å¯¹è±¡ï¼š

```json
{"message": {"role": "user", "content": "ä½ å¥½", "timestamp": 1234567890}}
{"message": {"role": "assistant", "content": [{"type": "text", "text": "ä½ å¥½ï¼"}], "timestamp": 1234567891}}
{"message": {"role": "toolResult", "content": [{"type": "text", "text": "æ‰§è¡Œç»“æœ..."}], "toolCallId": "xxx"}}
```

**è®¾è®¡ä¼˜åŠ¿**:

- **å¢é‡å†™å…¥**: æ¯æ¡æ¶ˆæ¯è¿½åŠ å†™å…¥ï¼Œé¿å…é‡å†™æ•´ä¸ªæ–‡ä»¶
- **å®¹é”™æ€§å¼º**: å•è¡ŒæŸåä¸å½±å“å…¶ä»–æ¶ˆæ¯
- **æµå¼è¯»å–**: å¯ä»¥é€è¡Œè¯»å–å¤„ç†å¤§æ–‡ä»¶

#### 4.4.3 Token ç®¡ç†ä¸ä¼°ç®—

**æ–‡ä»¶**: `src/agents/compaction.ts`

```typescript
import type { AgentMessage } from "@mariozechner/pi-agent-core";
import { estimateTokens, generateSummary } from "@mariozechner/pi-coding-agent";
import { DEFAULT_CONTEXT_TOKENS } from "./defaults.js";

export const BASE_CHUNK_RATIO = 0.4;
export const MIN_CHUNK_RATIO = 0.15;
export const SAFETY_MARGIN = 1.2; // 20% buffer for estimateTokens() inaccuracy

export function estimateMessagesTokens(messages: AgentMessage[]): number {
  return messages.reduce((sum, message) => sum + estimateTokens(message), 0);
}
```

**å…³é”®å¸¸é‡**:

| å¸¸é‡ | å€¼ | è¯´æ˜ |
|------|-----|------|
| `DEFAULT_CONTEXT_TOKENS` | 200,000 | é»˜è®¤ä¸Šä¸‹æ–‡çª—å£ |
| `BASE_CHUNK_RATIO` | 0.4 | åŸºç¡€åˆ†å—æ¯”ä¾‹ |
| `MIN_CHUNK_RATIO` | 0.15 | æœ€å°åˆ†å—æ¯”ä¾‹ |
| `SAFETY_MARGIN` | 1.2 | 20% å®‰å…¨è¾¹ç•Œ |
| `CHARS_PER_TOKEN_ESTIMATE` | 4 | å­—ç¬¦/Token ä¼°ç®—æ¯” |
| `IMAGE_CHAR_ESTIMATE` | 8,000 | å›¾ç‰‡å­—ç¬¦ä¼°ç®—å€¼ |

#### 4.4.4 ä¸Šä¸‹æ–‡çª—å£ä¿æŠ¤

**æ–‡ä»¶**: `src/agents/context-window-guard.ts`

```typescript
CONTEXT_WINDOW_HARD_MIN_TOKENS = 16_000;   // ç¡¬æ€§æœ€å°å€¼
CONTEXT_WINDOW_WARN_BELOW_TOKENS = 32_000; // è­¦å‘Šé˜ˆå€¼

// ä¸Šä¸‹æ–‡ä¿¡æ¯è§£æä¼˜å…ˆçº§ï¼š
// 1. modelsConfig (é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡å‹é…ç½®)
// 2. model (æ¨¡å‹å…ƒæ•°æ®)
// 3. agentContextTokens (ä»£ç†é…ç½®)
// 4. default (é»˜è®¤å€¼: 200,000)
```

#### 4.4.5 Context Pruning (ä¸Šä¸‹æ–‡è£å‰ª)

è¿™æ˜¯**æ ¸å¿ƒçš„å®æ—¶è£å‰ªæœºåˆ¶**ï¼Œåœ¨æ¯æ¬¡ Agent è¿è¡Œæ—¶æ‰§è¡Œã€‚

**æ–‡ä»¶**: `src/agents/pi-extensions/context-pruning/pruner.ts`

```typescript
const CHARS_PER_TOKEN_ESTIMATE = 4;
const IMAGE_CHAR_ESTIMATE = 8_000;  // å›¾ç‰‡æŒ‰ 8000 å­—ç¬¦è®¡ç®—

function estimateMessageChars(message: AgentMessage): number {
  if (message.role === "user") {
    // å¤„ç†æ–‡æœ¬å’Œå›¾ç‰‡
  }
  if (message.role === "assistant") {
    // å¤„ç†æ–‡æœ¬ã€thinkingã€toolCall
  }
  if (message.role === "toolResult") {
    // å¤„ç†å·¥å…·ç»“æœï¼ˆæ–‡æœ¬+å›¾ç‰‡ï¼‰
  }
}
```

#### ä¸¤çº§è£å‰ªç­–ç•¥

**è½¯è£å‰ª (Soft Trim)**:

```typescript
// é…ç½®å‚æ•°
softTrimRatio: 0.3,           // å ç”¨ 30% ä¸Šä¸‹æ–‡æ—¶è§¦å‘
softTrim: {
  maxChars: 4_000,            // è¶…è¿‡ 4000 å­—ç¬¦è§¦å‘è£å‰ª
  headChars: 1_500,           // ä¿ç•™å¼€å¤´ 1500 å­—ç¬¦
  tailChars: 1_500,           // ä¿ç•™ç»“å°¾ 1500 å­—ç¬¦
}

// è£å‰ªåçš„æ ¼å¼
"[å‰ 1500 å­—ç¬¦]\n\n[... ä¸­é—´å†…å®¹å·²è£å‰ª ...]\n\n[å 1500 å­—ç¬¦]"
```

**ç¡¬æ¸…é™¤ (Hard Clear)**:

```typescript
// é…ç½®å‚æ•°
hardClearRatio: 0.5,              // å ç”¨ 50% ä¸Šä¸‹æ–‡æ—¶è§¦å‘
minPrunableToolChars: 50_000,     // æœ€å°å¯è£å‰ªå­—ç¬¦æ•°
hardClear: {
  enabled: true,
  placeholder: "[Old tool result content cleared]",
}
```

**è£å‰ªæµç¨‹å›¾**:

```
è®¡ç®—å½“å‰ä¸Šä¸‹æ–‡å ç”¨æ¯”ä¾‹ (ratio)
              â”‚
              â–¼
   ratio < 0.3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ ä¸è£å‰ª
              â”‚
              â–¼
  0.3 â‰¤ ratio < 0.5 â”€â”€â”€â”€â†’ è½¯è£å‰ªå·¥å…·ç»“æœ
              â”‚            (ä¿ç•™å¤´å°¾)
              â–¼
    ratio â‰¥ 0.5 â”€â”€â”€â”€â”€â”€â”€â”€â†’ ç¡¬æ¸…é™¤å·¥å…·ç»“æœ
                          (æ›¿æ¢ä¸ºå ä½ç¬¦)
              â”‚
              â–¼
    ä¿æŠ¤é¦–ä¸ªç”¨æˆ·æ¶ˆæ¯ä¹‹å‰çš„å†…å®¹
    (bootstrap files)
```

#### 4.4.6 Compaction Safeguard (å‹ç¼©å®‰å…¨æœºåˆ¶)

å½“ä¼šè¯éœ€è¦è¿›è¡Œ**ä¸»åŠ¨å‹ç¼©**ï¼ˆç”Ÿæˆå†å²æ‘˜è¦ï¼‰æ—¶è§¦å‘ã€‚

**æ–‡ä»¶**: `src/agents/pi-extensions/compaction-safeguard.ts`

```typescript
// è§¦å‘æ—¶æœº: session_before_compact äº‹ä»¶
api.on("session_before_compact", async (event, ctx) => {
  // 1. è®¡ç®—æ–‡ä»¶æ“ä½œæ‘˜è¦
  const fileSummary = computeFileSummary(messages);
  // åŒ…å«ï¼šè¯»å–çš„æ–‡ä»¶ã€ä¿®æ”¹çš„æ–‡ä»¶ã€åˆ›å»ºçš„æ–‡ä»¶
  
  // 2. æ”¶é›†å·¥å…·å¤±è´¥è®°å½•
  const failedTools = collectToolFailures(messages);
  
  // 3. å¦‚æœæ–°å†…å®¹è¶…è¿‡å†å²é¢„ç®—ï¼Œè£å‰ªæ—§æ¶ˆæ¯
  const pruned = pruneHistoryForContextShare({
    messages,
    maxContextTokens,
    maxHistoryShare: 0.5,  // å†å²æœ€å¤šå  50%
  });
  
  // 4. ä¸ºè¢«è£å‰ªçš„æ¶ˆæ¯ç”Ÿæˆæ‘˜è¦
  const droppedSummary = await summarizeInStages({
    messages: pruned.droppedMessagesList,
  });
  
  // 5. åˆå¹¶ç”Ÿæˆæœ€ç»ˆå†å²æ‘˜è¦
  return {
    additionalHistory: [fileSummary, failedTools, droppedSummary].join("\n"),
  };
});
```

#### 4.4.7 åˆ†é˜¶æ®µæ‘˜è¦ç”Ÿæˆ (summarizeInStages)

**æ–‡ä»¶**: `src/agents/compaction.ts`

```typescript
export function splitMessagesByTokenShare(
  messages: AgentMessage[],
  parts = DEFAULT_PARTS,
): AgentMessage[][] {
  // å°†æ¶ˆæ¯æŒ‰ token æ•°é‡å‡åŒ€åˆ†æˆå¤šä»½
  const totalTokens = estimateMessagesTokens(messages);
  const targetTokens = totalTokens / normalizedParts;
  // ...
}

export function chunkMessagesByMaxTokens(
  messages: AgentMessage[],
  maxTokens: number,
): AgentMessage[][] {
  // ç¡®ä¿æ¯ä¸ªå—ä¸è¶…è¿‡ maxTokens
  // å¤„ç†è¶…å¤§æ¶ˆæ¯ï¼šå•ç‹¬æˆå—
}
```

**æ‘˜è¦ç”Ÿæˆæµç¨‹**:

```
åŸå§‹æ¶ˆæ¯åˆ—è¡¨ (N æ¡)
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ splitMessagesByTokenShare â”‚
  â”‚   (æŒ‰ token å‡åˆ†)         â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Part 1 â”‚ â”‚ Part 2 â”‚  (é»˜è®¤åˆ† 2 ä»½)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Summary â”‚ â”‚Summary â”‚  (å„è‡ªç”Ÿæˆæ‘˜è¦)
â”‚   1    â”‚ â”‚   2    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  Merge Summaries â”‚
  â”‚  (åˆå¹¶ä¸ºæœ€ç»ˆæ‘˜è¦) â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    æœ€ç»ˆå†å²æ‘˜è¦
```

#### 4.4.8 å†å²è½®æ¬¡é™åˆ¶

**æ–‡ä»¶**: `src/agents/pi-embedded-runner/history.ts`

```typescript
export function limitHistoryTurns(
  messages: AgentMessage[],
  limit: number,
): AgentMessage[] {
  // ä¿ç•™æœ€å N ä¸ªç”¨æˆ·è½®æ¬¡
  // ä»åå‘å‰æ‰«æ user æ¶ˆæ¯
  // è¶…è¿‡ limit çš„è½®æ¬¡è¢«ä¸¢å¼ƒ
}

// é…ç½®ç¤ºä¾‹
config.channels.telegram.dmHistoryLimit = 50;  // å…¨å±€é™åˆ¶
config.channels.telegram.dms["user123"].historyLimit = 100;  // ç”¨æˆ·ç‰¹å®šé™åˆ¶
```

### 4.5 äº‹ä»¶é©±åŠ¨çš„æ¶ˆæ¯å¤„ç†

**æ–‡ä»¶**: `src/agents/pi-embedded-subscribe.ts`

Agent ä½¿ç”¨**äº‹ä»¶é©±åŠ¨æ¨¡å‹**å¤„ç† LLM çš„æµå¼å“åº”ã€‚è¿™æ˜¯ä¸€ä¸ª**å‘å¸ƒ-è®¢é˜…æ¨¡å¼**çš„å®ç°ã€‚

#### 4.5.1 ä¸ºä»€ä¹ˆéœ€è¦äº‹ä»¶é©±åŠ¨ï¼Ÿ

å½“ LLM ç”Ÿæˆå›å¤æ—¶ï¼Œå®ƒä¸æ˜¯ä¸€æ¬¡æ€§è¿”å›å®Œæ•´å†…å®¹ï¼Œè€Œæ˜¯**é€å­—ç¬¦/é€ Token æµå¼è¾“å‡º**ã€‚ä¸ºäº†å®æ—¶å¤„ç†è¿™äº›å†…å®¹ï¼Œç³»ç»Ÿéœ€è¦ï¼š

1. **è®¢é˜…** LLM çš„è¾“å‡ºæµ
2. **ç›‘å¬** å„ç§äº‹ä»¶ï¼ˆå¼€å§‹ã€æ›´æ–°ã€ç»“æŸã€å·¥å…·è°ƒç”¨ç­‰ï¼‰
3. **åˆ†å‘** äº‹ä»¶åˆ°å¯¹åº”çš„å¤„ç†å™¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       äº‹ä»¶é©±åŠ¨æ¶ˆæ¯å¤„ç†æµç¨‹                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    LLM æµå¼è¾“å‡º
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  session.subscribe()  â”‚  â† è®¢é˜…ä¼šè¯äº‹ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ äº‹ä»¶æµ
   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â–¼           â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚messageâ”‚  â”‚messageâ”‚  â”‚messageâ”‚  â”‚ tool â”‚  â”‚agent â”‚
â”‚_start â”‚  â”‚_updateâ”‚  â”‚_end  â”‚  â”‚_exec â”‚  â”‚_end  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜
   â”‚           â”‚         â”‚         â”‚         â”‚
   â–¼           â–¼         â–¼         â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          switch (evt.type) { ... }               â”‚  â† äº‹ä»¶åˆ†å‘å™¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚           â”‚         â”‚         â”‚         â”‚
   â–¼           â–¼         â–¼         â–¼         â–¼
å¤„ç†å™¨1     å¤„ç†å™¨2    å¤„ç†å™¨3   å¤„ç†å™¨4   å¤„ç†å™¨5
```

#### 4.5.2 è®¢é˜…ä¼šè¯äº‹ä»¶

```typescript
export function subscribeEmbeddedPiSession(params: SubscribeEmbeddedPiSessionParams) {
  // 1. åˆå§‹åŒ–çŠ¶æ€ï¼ˆç”¨äºè·¨äº‹ä»¶å…±äº«æ•°æ®ï¼‰
  const state: EmbeddedPiSubscribeState = {
    assistantTexts: [],           // æ”¶é›† assistant å›å¤
    toolMetas: [],                // æ”¶é›†å·¥å…·è°ƒç”¨å…ƒæ•°æ®
    toolMetaById: new Map(),      // æŒ‰ ID ç´¢å¼•å·¥å…·å…ƒæ•°æ®
    deltaBuffer: "",              // æµå¼æ–‡æœ¬ç¼“å†²ï¼ˆç´¯ç§¯å·²æ”¶åˆ°çš„æ–‡æœ¬ï¼‰
    blockBuffer: "",              // å—ç¼“å†²ï¼ˆç”¨äºåˆ†å—å›å¤ï¼‰
  };
  
  // 2. åˆ›å»ºä¸Šä¸‹æ–‡å¯¹è±¡ï¼ˆåŒ…å«çŠ¶æ€ + å·¥å…·å‡½æ•°ï¼‰
  const ctx: EmbeddedPiSubscribeContext = {
    params,              // åŸå§‹å‚æ•°
    state,               // å…±äº«çŠ¶æ€
    log,                 // æ—¥å¿—å™¨
    // ... å„ç§å·¥å…·å‡½æ•°
  };
  
  // 3. åˆ›å»ºäº‹ä»¶å¤„ç†å™¨å¹¶è®¢é˜…
  const handler = createEmbeddedPiSessionEventHandler(ctx);
  const unsubscribe = params.session.subscribe(handler);
  
  // 4. è¿”å›ç»“æœå’Œå–æ¶ˆè®¢é˜…å‡½æ•°
  return { assistantTexts, toolMetas, unsubscribe };
}
```

**å…³é”®æ¦‚å¿µ**ï¼š

| æ¦‚å¿µ | è¯´æ˜ |
|------|------|
| **state** | è·¨äº‹ä»¶å…±äº«çš„å¯å˜çŠ¶æ€ï¼Œä¿å­˜ç´¯ç§¯çš„æ–‡æœ¬ã€å·¥å…·ä¿¡æ¯ç­‰ |
| **ctx** | ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒåŒ…å« state + å„ç§å¤„ç†å‡½æ•°ï¼Œä¼ é€’ç»™æ¯ä¸ªå¤„ç†å™¨ |
| **handler** | äº‹ä»¶å¤„ç†å™¨ï¼Œä¸€ä¸ªå‡½æ•°ï¼Œæ¥æ”¶äº‹ä»¶å¹¶åˆ†å‘ |
| **subscribe** | è®¢é˜…æ–¹æ³•ï¼Œæ³¨å†Œ handler åˆ°ä¼šè¯çš„äº‹ä»¶æµ |

#### 4.5.3 äº‹ä»¶åˆ†å‘å™¨åŸç†

**æ–‡ä»¶**: `src/agents/pi-embedded-subscribe.handlers.ts`

```typescript
// è¿™æ˜¯ä¸€ä¸ª"å·¥å‚å‡½æ•°"ï¼Œè¿”å›ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨
export function createEmbeddedPiSessionEventHandler(ctx: EmbeddedPiSubscribeContext) {
  // è¿”å›çš„å‡½æ•°ä¼šè¢«æ¯ä¸ªäº‹ä»¶è°ƒç”¨
  return (evt: EmbeddedPiSubscribeEvent) => {
    // æ ¹æ®äº‹ä»¶ç±»å‹åˆ†å‘åˆ°ä¸åŒå¤„ç†å™¨
    switch (evt.type) {
      case "message_start":
        handleMessageStart(ctx, evt);    // â†’ handlers.messages.ts
        return;
      case "message_update":
        handleMessageUpdate(ctx, evt);   // â†’ handlers.messages.ts (æ ¸å¿ƒï¼)
        return;
      case "message_end":
        handleMessageEnd(ctx, evt);      // â†’ handlers.messages.ts
        return;
      case "tool_execution_start":
        handleToolExecutionStart(ctx, evt);  // â†’ handlers.tools.ts
        return;
      case "tool_execution_update":
        handleToolExecutionUpdate(ctx, evt); // â†’ handlers.tools.ts
        return;
      case "tool_execution_end":
        handleToolExecutionEnd(ctx, evt);    // â†’ handlers.tools.ts
        return;
      case "agent_start":
        handleAgentStart(ctx);           // â†’ handlers.lifecycle.ts
        return;
      case "auto_compaction_start":
        handleAutoCompactionStart(ctx);  // â†’ handlers.lifecycle.ts
        return;
      case "auto_compaction_end":
        handleAutoCompactionEnd(ctx, evt); // â†’ handlers.lifecycle.ts
        return;
      case "agent_end":
        handleAgentEnd(ctx);             // â†’ handlers.lifecycle.ts
        return;
    }
  };
}
```

**åˆ†å‘åŸç†å›¾è§£**ï¼š

```
                    evt = { type: "message_update", delta: "Hello" }
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  switch (evt.type)                                                 â”‚
â”‚                                                                    â”‚
â”‚   evt.type === "message_start"   ?  â†’ handleMessageStart(ctx, evt) â”‚
â”‚   evt.type === "message_update"  ?  â†’ handleMessageUpdate(ctx, evt)â”‚ â† å‘½ä¸­ï¼
â”‚   evt.type === "message_end"     ?  â†’ handleMessageEnd(ctx, evt)   â”‚
â”‚   evt.type === "tool_*"          ?  â†’ handleTool*(ctx, evt)        â”‚
â”‚   evt.type === "agent_*"         ?  â†’ handleAgent*(ctx)            â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
                          handleMessageUpdate(ctx, evt)
                                        â”‚
                                        â–¼
                          ctx.state.deltaBuffer += "Hello"
                          ctx.params.onPartialReply?.("Hello")
```

#### 4.5.4 äº‹ä»¶ç±»å‹è¯¦è§£

| äº‹ä»¶ç±»å‹ | è§¦å‘æ—¶æœº | ä¸»è¦å¤„ç† |
|----------|----------|----------|
| `message_start` | LLM å¼€å§‹ç”Ÿæˆæ–°æ¶ˆæ¯ | é‡ç½®çŠ¶æ€ï¼Œè§¦å‘"æ­£åœ¨è¾“å…¥"æŒ‡ç¤º |
| `message_update` | LLM æµå¼è¾“å‡ºæ¯ä¸ª token | **æ ¸å¿ƒ**ï¼šç´¯ç§¯æ–‡æœ¬ã€è§¦å‘æµå¼å›å¤ |
| `message_end` | LLM æ¶ˆæ¯ç”Ÿæˆå®Œæˆ | æœ€ç»ˆåŒ–æ–‡æœ¬ã€è§¦å‘å®Œæ•´å›å¤ |
| `tool_execution_start` | å·¥å…·å¼€å§‹æ‰§è¡Œ | æ˜¾ç¤ºå·¥å…·æ‰§è¡ŒçŠ¶æ€ |
| `tool_execution_update` | å·¥å…·æ‰§è¡Œä¸­æ›´æ–° | æ›´æ–°æ‰§è¡Œè¿›åº¦ |
| `tool_execution_end` | å·¥å…·æ‰§è¡Œå®Œæˆ | æ”¶é›†å·¥å…·ç»“æœã€é”™è¯¯å¤„ç† |
| `agent_start` | Agent å¾ªç¯å¼€å§‹ | åˆå§‹åŒ– |
| `agent_end` | Agent å¾ªç¯ç»“æŸ | æ¸…ç†ã€æœ€ç»ˆåŒ– |
| `auto_compaction_start` | ä¸Šä¸‹æ–‡å‹ç¼©å¼€å§‹ | æ ‡è®°å‹ç¼©è¿›è¡Œä¸­ |
| `auto_compaction_end` | ä¸Šä¸‹æ–‡å‹ç¼©å®Œæˆ | æ¢å¤æ­£å¸¸å¤„ç† |

#### 4.5.5 message_update å¤„ç†è¯¦è§£ï¼ˆæœ€æ ¸å¿ƒï¼‰

**æ–‡ä»¶**: `src/agents/pi-embedded-subscribe.handlers.messages.ts`

```typescript
export function handleMessageUpdate(ctx, evt) {
  const msg = evt.message;
  if (msg?.role !== "assistant") return;  // åªå¤„ç† assistant æ¶ˆæ¯
  
  // 1. è§£æäº‹ä»¶å­ç±»å‹
  const evtType = assistantRecord.type;  // "text_delta" | "text_start" | "text_end"
  const delta = assistantRecord.delta;    // æœ¬æ¬¡å¢é‡æ–‡æœ¬
  
  // 2. å¤„ç†ä¸åŒå­ç±»å‹
  if (evtType === "text_delta") {
    chunk = delta;  // ç›´æ¥ä½¿ç”¨å¢é‡
  } else if (evtType === "text_end") {
    // è®¡ç®—å¢é‡ï¼ˆé˜²æ­¢é‡å¤ï¼‰
    if (content.startsWith(ctx.state.deltaBuffer)) {
      chunk = content.slice(ctx.state.deltaBuffer.length);
    }
  }
  
  // 3. ç´¯ç§¯åˆ°ç¼“å†²åŒº
  ctx.state.deltaBuffer += chunk;
  
  // 4. è§¦å‘æµå¼å›å¤å›è°ƒ
  ctx.params.onPartialReply?.(ctx.state.deltaBuffer);
  
  // 5. å¤„ç†æ€è€ƒæ ‡ç­¾ <think>...</think>
  // 6. å¤„ç†å—åˆ†å‰²ï¼ˆé•¿æ¶ˆæ¯åˆ†å—å‘é€ï¼‰
}
```

**æµå¼å¤„ç†ç¤ºæ„**ï¼š

```
LLM è¾“å‡º:  "H" â†’ "e" â†’ "l" â†’ "l" â†’ "o" â†’ " " â†’ "W" â†’ "o" â†’ "r" â†’ "l" â†’ "d"

äº‹ä»¶æµ:
  message_start
  message_update { delta: "H" }      â†’ deltaBuffer = "H"
  message_update { delta: "e" }      â†’ deltaBuffer = "He"
  message_update { delta: "l" }      â†’ deltaBuffer = "Hel"
  message_update { delta: "l" }      â†’ deltaBuffer = "Hell"
  message_update { delta: "o" }      â†’ deltaBuffer = "Hello"
  message_update { delta: " " }      â†’ deltaBuffer = "Hello "
  message_update { delta: "W" }      â†’ deltaBuffer = "Hello W"
  ...
  message_end { content: "Hello World" }  â†’ æœ€ç»ˆç¡®è®¤
```

#### 4.5.6 å¤„ç†å™¨æ–‡ä»¶ç»„ç»‡

```
src/agents/
â”œâ”€â”€ pi-embedded-subscribe.ts                    # å…¥å£ï¼šè®¢é˜…å‡½æ•°
â”œâ”€â”€ pi-embedded-subscribe.handlers.ts           # åˆ†å‘å™¨ï¼šswitch è·¯ç”±
â”œâ”€â”€ pi-embedded-subscribe.handlers.types.ts     # ç±»å‹å®šä¹‰
â”œâ”€â”€ pi-embedded-subscribe.handlers.messages.ts  # æ¶ˆæ¯å¤„ç†å™¨
â”œâ”€â”€ pi-embedded-subscribe.handlers.tools.ts     # å·¥å…·å¤„ç†å™¨
â””â”€â”€ pi-embedded-subscribe.handlers.lifecycle.ts # ç”Ÿå‘½å‘¨æœŸå¤„ç†å™¨
```

### 4.6 å·¥å…·è°ƒç”¨å¤„ç†

**æ–‡ä»¶**: `src/agents/pi-embedded-subscribe.handlers.tools.ts`

å½“ LLM å†³å®šè°ƒç”¨å·¥å…·æ—¶çš„å¤„ç†æµç¨‹ï¼š

```typescript
export async function handleToolExecutionStart(
  ctx: EmbeddedPiSubscribeContext,
  evt: AgentEvent & { toolName: string; toolCallId: string; args: unknown },
) {
  // 1. è®°å½•å·¥å…·å…ƒæ•°æ®
  const toolName = normalizeToolName(evt.toolName);
  const meta = inferToolMetaFromArgs(toolName, evt.args);
  ctx.state.toolMetaById.set(evt.toolCallId, meta);
  
  // 2. å‘é€å·¥å…·å¼€å§‹äº‹ä»¶
  emitAgentEvent({
    runId: ctx.params.runId,
    stream: "tool",
    data: { phase: "start", name: toolName, toolCallId: evt.toolCallId, args: evt.args },
  });
}

export function handleToolExecutionEnd(
  ctx: EmbeddedPiSubscribeContext,
  evt: AgentEvent & { toolName: string; toolCallId: string; result: unknown },
) {
  const toolName = normalizeToolName(evt.toolName);
  const meta = ctx.state.toolMetaById.get(evt.toolCallId);
  
  // 1. è®°å½•å·¥å…·ç»“æœ
  ctx.state.toolMetas.push({ toolName, meta });
  
  // 2. å‘é€å·¥å…·ç»“æŸäº‹ä»¶
  emitAgentEvent({
    runId: ctx.params.runId,
    stream: "tool",
    data: { phase: "result", name: toolName, toolCallId: evt.toolCallId, result: evt.result },
  });
}
```

**å·¥å…·è°ƒç”¨çš„æœ¬è´¨**ï¼šLLM è¿”å›ä¸€ä¸ªç»“æ„åŒ–çš„å·¥å…·è°ƒç”¨è¯·æ±‚ï¼ˆåŒ…å«å·¥å…·åå’Œå‚æ•°ï¼‰ï¼ŒAgent æ¡†æ¶æ‰§è¡Œè¯¥å·¥å…·ï¼Œç„¶åå°†ç»“æœè¿”å›ç»™ LLM ç»§ç»­å¤„ç†ã€‚

#### å·¥å…·è°ƒç”¨å®Œæ•´ç¤ºä¾‹

ä»¥ç”¨æˆ·é—®"å½“å‰ç›®å½•æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ"ä¸ºä¾‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·: "å½“å‰ç›®å½•æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ"                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 1 è½®ï¼šLLM åˆ†æå¹¶å†³å®šè°ƒç”¨å·¥å…·                                              â”‚
â”‚                                                                             â”‚
â”‚  LLM è¿”å›:                                                                  â”‚
â”‚  {                                                                          â”‚
â”‚    "type": "tool_call",                                                     â”‚
â”‚    "tool_name": "list_files",                                               â”‚
â”‚    "tool_call_id": "call_abc123",                                           â”‚
â”‚    "arguments": {                                                           â”‚
â”‚      "path": ".",                                                           â”‚
â”‚      "recursive": false                                                     â”‚
â”‚    }                                                                        â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                               â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ tool_execution  â”‚            â”‚  Agent æ¡†æ¶æ‰§è¡Œå·¥å…·      â”‚
         â”‚ _start äº‹ä»¶     â”‚            â”‚                         â”‚
         â”‚                 â”‚            â”‚  fs.readdir(".")        â”‚
         â”‚ â†’ æ˜¾ç¤º"æ­£åœ¨     â”‚            â”‚  â†’ ["src/", "docs/",    â”‚
         â”‚   åˆ—å‡ºæ–‡ä»¶..."  â”‚            â”‚     "package.json",     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚     "README.md"]        â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  tool_execution_end äº‹ä»¶                                                    â”‚
â”‚                                                                             â”‚
â”‚  {                                                                          â”‚
â”‚    "type": "tool_result",                                                   â”‚
â”‚    "tool_call_id": "call_abc123",                                           â”‚
â”‚    "result": "src/\ndocs/\npackage.json\nREADME.md"                         â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ 2 è½®ï¼šLLM æ”¶åˆ°å·¥å…·ç»“æœï¼Œç”Ÿæˆæœ€ç»ˆå›å¤                                       â”‚
â”‚                                                                             â”‚
â”‚  LLM è¾“å…¥ä¸Šä¸‹æ–‡:                                                             â”‚
â”‚  - ç”¨æˆ·æ¶ˆæ¯: "å½“å‰ç›®å½•æœ‰ä»€ä¹ˆæ–‡ä»¶ï¼Ÿ"                                           â”‚
â”‚  - å·¥å…·è°ƒç”¨: list_files(path=".")                                           â”‚
â”‚  - å·¥å…·ç»“æœ: "src/\ndocs/\npackage.json\nREADME.md"                          â”‚
â”‚                                                                             â”‚
â”‚  LLM è¿”å›:                                                                  â”‚
â”‚  "å½“å‰ç›®å½•åŒ…å«ä»¥ä¸‹æ–‡ä»¶å’Œæ–‡ä»¶å¤¹ï¼š                                              â”‚
â”‚   - src/ (æºä»£ç ç›®å½•)                                                        â”‚
â”‚   - docs/ (æ–‡æ¡£ç›®å½•)                                                         â”‚
â”‚   - package.json (é¡¹ç›®é…ç½®)                                                  â”‚
â”‚   - README.md (é¡¹ç›®è¯´æ˜)"                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æ”¶åˆ°å›å¤ âœ…                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç†è§£ç‚¹**ï¼š

| é˜¶æ®µ | æ‰§è¡Œè€… | åŠ¨ä½œ |
|------|--------|------|
| 1. åˆ†æé—®é¢˜ | **LLM** | ç†è§£ç”¨æˆ·æ„å›¾ï¼Œå†³å®šéœ€è¦è°ƒç”¨ä»€ä¹ˆå·¥å…· |
| 2. ç”Ÿæˆè°ƒç”¨ | **LLM** | è¾“å‡ºç»“æ„åŒ–çš„å·¥å…·è°ƒç”¨è¯·æ±‚ï¼ˆJSON æ ¼å¼ï¼‰ |
| 3. æ‰§è¡Œå·¥å…· | **Agent æ¡†æ¶** | è§£æè¯·æ±‚ï¼Œè°ƒç”¨å®é™…çš„ç³»ç»Ÿ API |
| 4. è¿”å›ç»“æœ | **Agent æ¡†æ¶** | å°†æ‰§è¡Œç»“æœæ³¨å…¥åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ |
| 5. ç”Ÿæˆå›å¤ | **LLM** | åŸºäºå·¥å…·ç»“æœï¼Œç”Ÿæˆäººç±»å¯è¯»çš„å›å¤ |

**æœ¬è´¨**ï¼šLLM æœ¬èº«**ä¸èƒ½**æ‰§è¡Œä»£ç æˆ–è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒåªèƒ½"è¯´"è¦åšä»€ä¹ˆã€‚Agent æ¡†æ¶è´Ÿè´£"å¬æ‡‚"å¹¶"æ‰§è¡Œ"ï¼Œç„¶åæŠŠç»“æœ"å‘Šè¯‰" LLMã€‚

### 4.7 å·¥å…·ç³»ç»Ÿ

**æ–‡ä»¶**: `src/agents/pi-tools.ts`

OpenClaw æä¾›äº†ä¸°å¯Œçš„å†…ç½®å·¥å…·ï¼š

```typescript
export function createOpenClawCodingTools(options?: {...}): AnyAgentTool[] {
  // 1. åˆ›å»ºåŸºç¡€ç¼–ç å·¥å…·
  const base = codingTools.flatMap((tool) => {
    if (tool.name === readTool.name) {
      return [createOpenClawReadTool(...)];
    }
    // ...
  });
  
  // 2. åˆ›å»ºæ‰§è¡Œå·¥å…·
  const execTool = createExecTool({ ... });
  
  // 3. åˆ›å»º OpenClaw ç‰¹æœ‰å·¥å…·
  const openclawTools = createOpenClawTools({...});
  
  // 4. æ·»åŠ é’©å­åŒ…è£…ï¼ˆbefore_tool_call hookï¼‰
  const withHooks = normalized.map(tool => 
    wrapToolWithBeforeToolCallHook(tool, {...})
  );
  
  return withHooks;
}
```

**æ ¸å¿ƒå†…ç½®å·¥å…·**:

| å·¥å…·å | åŠŸèƒ½æè¿° |
|--------|----------|
| `read` | è¯»å–æ–‡ä»¶å†…å®¹ |
| `write` | åˆ›å»ºæˆ–è¦†ç›–æ–‡ä»¶ |
| `edit` | ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶ |
| `grep` | æœç´¢æ–‡ä»¶å†…å®¹ |
| `find` | æŒ‰æ¨¡å¼æŸ¥æ‰¾æ–‡ä»¶ |
| `ls` | åˆ—å‡ºç›®å½•å†…å®¹ |
| `exec` | æ‰§è¡Œ shell å‘½ä»¤ |
| `web_search` | ç½‘ç»œæœç´¢ |
| `web_fetch` | è·å–ç½‘é¡µå†…å®¹ |
| `browser` | æ§åˆ¶æµè§ˆå™¨ |
| `message` | å‘é€æ¶ˆæ¯ |
| `memory_search` | è®°å¿†æœç´¢ |

### 4.8 Agent å¾ªç¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·å‘é€æ¶ˆæ¯                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    1. é˜Ÿåˆ—ç­‰å¾…ï¼ˆä¸²è¡ŒåŒ–ï¼‰                          â”‚
â”‚                    enqueueSession() + enqueueGlobal()           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    2. åˆ›å»º Agent ä¼šè¯                            â”‚
â”‚                    createAgentSession()                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    3. æ„å»ºç³»ç»Ÿæç¤ºè¯                              â”‚
â”‚                    buildAgentSystemPrompt()                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    4. è°ƒç”¨ LLM                                   â”‚
â”‚                    session.prompt(userMessage)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   LLM è¿”å›æ–‡æœ¬     â”‚   â”‚   LLM è¿”å›å·¥å…·è°ƒç”¨     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â”‚                       â–¼
                    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           â”‚   5. æ‰§è¡Œå·¥å…·          â”‚
                    â”‚           â”‚   tool.execute(args)  â”‚
                    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â”‚                       â–¼
                    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           â”‚   6. è¿”å›å·¥å…·ç»“æœ      â”‚
                    â”‚           â”‚   tool result â†’ LLM   â”‚
                    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚           â”‚  LLM å¯èƒ½ç»§ç»­è°ƒç”¨å·¥å…·  â”‚
                    â”‚           â”‚  (å¾ªç¯æ­¥éª¤ 4-6)       â”‚
                    â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    7. æ”¶é›†æœ€ç»ˆå›å¤                                â”‚
â”‚                    assistantTexts + toolMetas                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    8. è¿”å›ç»™ç”¨æˆ·                                  â”‚
â”‚                    é€šè¿‡åŸæ¸ é“å‘é€å›å¤                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Agent å¾ªç¯çš„æœ¬è´¨**ï¼šç”¨æˆ·æ¶ˆæ¯ â†’ LLM æ€è€ƒ â†’ (å¯é€‰)è°ƒç”¨å·¥å…· â†’ å·¥å…·ç»“æœè¿”å› LLM â†’ LLM ç»§ç»­æ€è€ƒ â†’ ... â†’ æœ€ç»ˆå›å¤

### 4.9 æ ¸å¿ƒä¾èµ–åº“

OpenClaw çš„ Agent æ ¸å¿ƒä¾èµ–äºä»¥ä¸‹å¤–éƒ¨åº“ï¼š

| åº“ | ä½œç”¨ |
|----|------|
| `@mariozechner/pi-agent-core` | Agent æ ¸å¿ƒç±»å‹å’Œæ¥å£å®šä¹‰ |
| `@mariozechner/pi-ai` | AI æ¨¡å‹è°ƒç”¨æŠ½è±¡å±‚ (streamSimple ç­‰) |
| `@mariozechner/pi-coding-agent` | ç¼–ç  Agent ä¼šè¯ç®¡ç†ã€å·¥å…·åˆ›å»º |

è¿™äº›åº“æä¾›äº†ï¼š
- **ç»Ÿä¸€çš„ LLM è°ƒç”¨æ¥å£**ï¼šæ”¯æŒå¤šä¸ªæ¨¡å‹æä¾›å•†
- **ä¼šè¯ç®¡ç†å’ŒæŒä¹…åŒ–**ï¼šä¿å­˜å¯¹è¯å†å²
- **å·¥å…·å®šä¹‰å’Œæ‰§è¡Œæ¡†æ¶**ï¼šæ ‡å‡†åŒ–çš„å·¥å…·æ¥å£
- **ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶**ï¼šå¤„ç†è¶…é•¿å¯¹è¯

---

## äº”ã€ç³»ç»Ÿæç¤ºè¯å·¥ç¨‹

ç³»ç»Ÿæç¤ºè¯ï¼ˆSystem Promptï¼‰æ˜¯ Agent çš„"çµé­‚"ï¼Œå®ƒå†³å®šäº† Agent çš„èº«ä»½ã€èƒ½åŠ›è¾¹ç•Œã€è¡Œä¸ºè§„èŒƒã€‚OpenClaw é‡‡ç”¨**æ¨¡å—åŒ–è®¾è®¡**ï¼Œå°†ç³»ç»Ÿæç¤ºè¯æ‹†åˆ†ä¸ºå¤šä¸ªç‹¬ç«‹çš„æ„å»ºå‡½æ•°ã€‚

**æ–‡ä»¶**: `src/agents/system-prompt.ts`

### 5.1 ç³»ç»Ÿæç¤ºè¯æ•´ä½“ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç³»ç»Ÿæç¤ºè¯ (System Prompt)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. èº«ä»½å£°æ˜ (Identity)                                          â”‚
â”‚     "You are a personal assistant running inside OpenClaw."     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2. å·¥å…·éƒ¨åˆ† (Tooling)                                           â”‚
â”‚     - å¯ç”¨å·¥å…·åˆ—è¡¨åŠæè¿°                                          â”‚
â”‚     - å·¥å…·è°ƒç”¨é£æ ¼æŒ‡å—                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  3. å®‰å…¨è§„åˆ™ (Safety)                                            â”‚
â”‚     - æ— ç‹¬ç«‹ç›®æ ‡                                                  â”‚
â”‚     - ä¼˜å…ˆå®‰å…¨å’Œäººç±»ç›‘ç£                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  4. CLI å¿«é€Ÿå‚è€ƒ (CLI Reference)                                 â”‚
â”‚     - OpenClaw å‘½ä»¤ç”¨æ³•                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5. Skills ç³»ç»Ÿ (Skills)                                         â”‚
â”‚     - æŠ€èƒ½æ‰«æè§„åˆ™                                                â”‚
â”‚     - æŠ€èƒ½é€‰æ‹©å’ŒåŠ è½½æŒ‡å—                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  6. è®°å¿†ç³»ç»Ÿ (Memory)                                            â”‚
â”‚     - è®°å¿†æ£€ç´¢æŒ‡å—                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  7. å·¥ä½œç©ºé—´ (Workspace)                                         â”‚
â”‚     - å½“å‰å·¥ä½œç›®å½•                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  8. æ–‡æ¡£å‚è€ƒ (Docs)                                              â”‚
â”‚     - OpenClaw æ–‡æ¡£è·¯å¾„                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  9. æ¶ˆæ¯ç³»ç»Ÿ (Messaging)                                         â”‚
â”‚     - è·¨ä¼šè¯æ¶ˆæ¯å‘é€                                              â”‚
â”‚     - message å·¥å…·ç”¨æ³•                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 10. é¡¹ç›®ä¸Šä¸‹æ–‡ (Project Context)                                 â”‚
â”‚     - AGENTS.md / SOUL.md ç­‰æ–‡ä»¶å†…å®¹                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11. é™é»˜å›å¤ (Silent Replies)                                    â”‚
â”‚     - æ— éœ€å›å¤æ—¶çš„å¤„ç†                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 12. è¿è¡Œæ—¶ä¿¡æ¯ (Runtime)                                         â”‚
â”‚     - agent/host/os/model ç­‰ç¯å¢ƒä¿¡æ¯                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»æ„å»ºå‡½æ•°**ï¼š

```typescript
// src/agents/system-prompt.ts
export function buildAgentSystemPrompt(params: {
  workspaceDir: string;           // å·¥ä½œç›®å½•
  toolNames?: string[];           // å¯ç”¨å·¥å…·ååˆ—è¡¨
  toolSummaries?: Record<string, string>;  // å·¥å…·æè¿°æ˜ å°„
  skillsPrompt?: string;          // Skills æç¤ºè¯
  contextFiles?: EmbeddedContextFile[];    // ä¸Šä¸‹æ–‡æ–‡ä»¶ï¼ˆå¦‚ AGENTS.mdï¼‰
  runtimeInfo?: {...};            // è¿è¡Œæ—¶ä¿¡æ¯
  // ...æ›´å¤šå‚æ•°
}) {
  const lines = [];
  
  // 1ï¸âƒ£ èº«ä»½å£°æ˜
  lines.push("You are a personal assistant running inside OpenClaw.");
  
  // 2ï¸âƒ£ å·¥å…·éƒ¨åˆ†
  lines.push("## Tooling", ...toolLines);
  
  // 3ï¸âƒ£ å®‰å…¨è§„åˆ™
  lines.push(...buildSafetySection());
  
  // 4ï¸âƒ£ CLI å‚è€ƒ
  lines.push("## OpenClaw CLI Quick Reference", ...);
  
  // 5ï¸âƒ£ Skills ç³»ç»Ÿ
  lines.push(...buildSkillsSection({...}));
  
  // 6ï¸âƒ£ è®°å¿†ç³»ç»Ÿ
  lines.push(...buildMemorySection({...}));
  
  // 7ï¸âƒ£ å·¥ä½œç©ºé—´
  lines.push("## Workspace", `Your working directory is: ${params.workspaceDir}`);
  
  // 8ï¸âƒ£ æ–‡æ¡£å‚è€ƒ
  lines.push(...buildDocsSection({...}));
  
  // 9ï¸âƒ£ æ¶ˆæ¯ç³»ç»Ÿ
  lines.push(...buildMessagingSection({...}));
  
  // ğŸ”Ÿ é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆå…³é”®ï¼ï¼‰
  if (contextFiles?.length > 0) {
    lines.push("# Project Context");
    for (const file of contextFiles) {
      lines.push(`## ${file.path}`, file.content);
    }
  }
  
  // 1ï¸âƒ£1ï¸âƒ£ é™é»˜å›å¤
  lines.push("## Silent Replies", ...);
  
  // 1ï¸âƒ£2ï¸âƒ£ è¿è¡Œæ—¶ä¿¡æ¯
  lines.push("## Runtime", buildRuntimeLine(runtimeInfo, ...));
  
  return lines.filter(Boolean).join("\n");
}
```

### 5.2 æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### â‘  å·¥å…·éƒ¨åˆ† (Tooling)

> âš ï¸ **é‡è¦è¯´æ˜**ï¼šSystem Prompt ä¸­çš„å·¥å…·éƒ¨åˆ†**åªåŒ…å«å·¥å…·åç§°å’Œç®€çŸ­æè¿°**ï¼Œå®Œæ•´çš„å‚æ•°å®šä¹‰ï¼ˆå…¥å‚/å‡ºå‚ Schemaï¼‰æ˜¯**é€šè¿‡ API çš„ `tools` å‚æ•°å•ç‹¬ä¼ é€’**ç»™ LLM çš„ï¼Œä¸åœ¨ system prompt æ–‡æœ¬ä¸­ã€‚
>
> ğŸ“Œ **æŠ€æœ¯åŸç†**ï¼šOpenClaw ä½¿ç”¨çš„æ˜¯ LLM çš„ **Function Callingï¼ˆå‡½æ•°è°ƒç”¨ï¼‰** åŠŸèƒ½ï¼Œè¿™æ˜¯ OpenAIã€Claudeã€Gemini ç­‰ä¸»æµ LLM éƒ½æ”¯æŒçš„æ ‡å‡†èƒ½åŠ›ã€‚Function Calling è®© LLM èƒ½å¤Ÿä»¥ç»“æ„åŒ– JSON æ ¼å¼"è°ƒç”¨"é¢„å®šä¹‰çš„å‡½æ•°ï¼Œè€Œä¸æ˜¯åªè¾“å‡ºè‡ªç„¶è¯­è¨€æ–‡æœ¬ã€‚

**Function Calling å·¥ä½œåŸç†**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Function Calling å®Œæ•´å·¥ä½œæµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 æ­¥ï¼šå¼€å‘è€…å®šä¹‰å‡½æ•°ï¼ˆå·¥å…·ï¼‰                                               â”‚
â”‚                                                                             â”‚
â”‚ const readTool = {                                                          â”‚
â”‚   name: "read",                                                             â”‚
â”‚   description: "Read file contents",                                        â”‚
â”‚   parameters: {                                                             â”‚
â”‚     type: "object",                                                         â”‚
â”‚     properties: {                                                           â”‚
â”‚       path: { type: "string", description: "File path to read" },           â”‚
â”‚       encoding: { type: "string", description: "File encoding" }            â”‚
â”‚     },                                                                      â”‚
â”‚     required: ["path"]                                                      â”‚
â”‚   }                                                                         â”‚
â”‚ };                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 æ­¥ï¼šè°ƒç”¨ LLM API æ—¶ä¼ å…¥ tools å‚æ•°                                       â”‚
â”‚                                                                             â”‚
â”‚ const response = await openai.chat.completions.create({                     â”‚
â”‚   model: "gpt-4",                                                           â”‚
â”‚   messages: [                                                               â”‚
â”‚     { role: "system", content: "You are a helpful assistant..." },          â”‚
â”‚     { role: "user", content: "è¯»å– package.json çš„å†…å®¹" }                    â”‚
â”‚   ],                                                                        â”‚
â”‚   tools: [{                           // â† å…³é”®ï¼šä¼ å…¥å·¥å…·å®šä¹‰                 â”‚
â”‚     type: "function",                                                       â”‚
â”‚     function: readTool                                                      â”‚
â”‚   }]                                                                        â”‚
â”‚ });                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 3 æ­¥ï¼šLLM åˆ†æç”¨æˆ·æ„å›¾ï¼Œå†³å®šæ˜¯å¦è°ƒç”¨å‡½æ•°                                    â”‚
â”‚                                                                             â”‚
â”‚ LLM å†…éƒ¨æ€è€ƒï¼š                                                               â”‚
â”‚ "ç”¨æˆ·æƒ³è¯»å– package.json â†’ æˆ‘éœ€è¦ä½¿ç”¨ read å·¥å…· â†’ å‚æ•°æ˜¯ path='package.json'"  â”‚
â”‚                                                                             â”‚
â”‚ LLM è¿”å›ï¼ˆä¸æ˜¯æ™®é€šæ–‡æœ¬ï¼Œè€Œæ˜¯ç»“æ„åŒ–çš„ tool_callsï¼‰ï¼š                            â”‚
â”‚ {                                                                           â”‚
â”‚   "choices": [{                                                             â”‚
â”‚     "message": {                                                            â”‚
â”‚       "role": "assistant",                                                  â”‚
â”‚       "content": null,               // â† æ²¡æœ‰æ–‡æœ¬å†…å®¹                       â”‚
â”‚       "tool_calls": [{               // â† è€Œæ˜¯å‡½æ•°è°ƒç”¨è¯·æ±‚                   â”‚
â”‚         "id": "call_abc123",                                                â”‚
â”‚         "type": "function",                                                 â”‚
â”‚         "function": {                                                       â”‚
â”‚           "name": "read",                                                   â”‚
â”‚           "arguments": "{\"path\": \"package.json\"}"                       â”‚
â”‚         }                                                                   â”‚
â”‚       }]                                                                    â”‚
â”‚     }                                                                       â”‚
â”‚   }]                                                                        â”‚
â”‚ }                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 4 æ­¥ï¼šAgent æ¡†æ¶æ‰§è¡Œå‡½æ•°                                                   â”‚
â”‚                                                                             â”‚
â”‚ // è§£æ LLM è¿”å›çš„è°ƒç”¨è¯·æ±‚                                                   â”‚
â”‚ const toolCall = response.choices[0].message.tool_calls[0];                 â”‚
â”‚ const args = JSON.parse(toolCall.function.arguments);                       â”‚
â”‚                                                                             â”‚
â”‚ // æ‰§è¡Œå®é™…çš„å‡½æ•°                                                            â”‚
â”‚ const result = await fs.readFile(args.path, "utf-8");                       â”‚
â”‚ // result = '{ "name": "openclaw", "version": "1.0.0", ... }'               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 5 æ­¥ï¼šæŠŠæ‰§è¡Œç»“æœè¿”å›ç»™ LLM                                                 â”‚
â”‚                                                                             â”‚
â”‚ const followUp = await openai.chat.completions.create({                     â”‚
â”‚   model: "gpt-4",                                                           â”‚
â”‚   messages: [                                                               â”‚
â”‚     { role: "system", content: "..." },                                     â”‚
â”‚     { role: "user", content: "è¯»å– package.json çš„å†…å®¹" },                   â”‚
â”‚     { role: "assistant", content: null, tool_calls: [...] },  // LLMçš„è°ƒç”¨  â”‚
â”‚     {                                                                       â”‚
â”‚       role: "tool",                   // â† å·¥å…·æ‰§è¡Œç»“æœ                      â”‚
â”‚       tool_call_id: "call_abc123",                                          â”‚
â”‚       content: '{ "name": "openclaw", "version": "1.0.0" }'                 â”‚
â”‚     }                                                                       â”‚
â”‚   ]                                                                         â”‚
â”‚ });                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 6 æ­¥ï¼šLLM åŸºäºå·¥å…·ç»“æœç”Ÿæˆæœ€ç»ˆå›å¤                                          â”‚
â”‚                                                                             â”‚
â”‚ LLM è¿”å›ï¼š                                                                   â”‚
â”‚ {                                                                           â”‚
â”‚   "choices": [{                                                             â”‚
â”‚     "message": {                                                            â”‚
â”‚       "role": "assistant",                                                  â”‚
â”‚       "content": "package.json çš„å†…å®¹å¦‚ä¸‹ï¼š\n\nè¿™æ˜¯ä¸€ä¸ªåä¸º openclaw çš„é¡¹ç›®ï¼Œâ”‚
â”‚                   ç‰ˆæœ¬å·æ˜¯ 1.0.0..."                                         â”‚
â”‚     }                                                                       â”‚
â”‚   }]                                                                        â”‚
â”‚ }                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Function Calling vs æ™®é€šå¯¹è¯**ï¼š

| å¯¹æ¯”é¡¹ | æ™®é€šå¯¹è¯ | Function Calling |
|--------|----------|------------------|
| **LLM è¾“å‡º** | è‡ªç„¶è¯­è¨€æ–‡æœ¬ | ç»“æ„åŒ– JSONï¼ˆtool_callsï¼‰ |
| **å‚æ•°æ ¼å¼** | æ— æ³•ä¿è¯ | ä¸¥æ ¼éµå¾ª JSON Schema |
| **å¯æ‰§è¡Œæ€§** | éœ€è¦è§£ææ–‡æœ¬ï¼ˆä¸å¯é ï¼‰ | å¯ç›´æ¥è§£ææ‰§è¡Œ |
| **é”™è¯¯å¤„ç†** | éš¾ä»¥åˆ¤æ–­ | æ¸…æ™°çš„è°ƒç”¨å¤±è´¥/æˆåŠŸ |

**å·¥å…·ä¿¡æ¯ä¼ é€’çš„ä¸¤ä¸ªé€šé“**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LLM API è°ƒç”¨ç»“æ„                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  system (System Prompt)   â”‚          â”‚  tools (å·¥å…·å®šä¹‰æ•°ç»„)       â”‚
â”‚                           â”‚          â”‚                            â”‚
â”‚  "## Tooling              â”‚          â”‚  [{                        â”‚
â”‚  - read: Read file...     â”‚          â”‚    name: "read",           â”‚
â”‚  - write: Create...       â”‚          â”‚    description: "...",     â”‚
â”‚  - edit: Make precise..." â”‚          â”‚    parameters: {           â”‚
â”‚                           â”‚          â”‚      type: "object",       â”‚
â”‚  (åªæœ‰åç§° + ç®€çŸ­æè¿°)     â”‚          â”‚      properties: {         â”‚
â”‚                           â”‚          â”‚        path: {...},        â”‚
â”‚                           â”‚          â”‚        encoding: {...}     â”‚
â”‚                           â”‚          â”‚      },                    â”‚
â”‚                           â”‚          â”‚      required: ["path"]    â”‚
â”‚                           â”‚          â”‚    }                       â”‚
â”‚                           â”‚          â”‚  }, ...]                   â”‚
â”‚                           â”‚          â”‚                            â”‚
â”‚                           â”‚          â”‚  (å®Œæ•´çš„ JSON Schema)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

| ä½ç½® | å†…å®¹ | ç›®çš„ |
|------|------|------|
| **System Prompt** | å·¥å…·å + ç®€çŸ­æè¿° | è®© LLM å¿«é€Ÿäº†è§£æœ‰å“ªäº›èƒ½åŠ›ï¼ŒèŠ‚çœ Token |
| **tools å‚æ•°** | å®Œæ•´ JSON Schema | LLM éœ€è¦ç²¾ç¡®çš„å‚æ•°å®šä¹‰æ‰èƒ½æ­£ç¡®è°ƒç”¨ |

#### â‘¡ å®‰å…¨è§„åˆ™ (Safety)

è¿™æ˜¯ Agent å®‰å…¨çš„æ ¸å¿ƒçº¦æŸï¼š

```typescript
function buildSafetySection() {
  return [
    "## Safety",
    // ğŸ”’ æ— ç‹¬ç«‹ç›®æ ‡çº¦æŸ
    "You have no independent goals: do not pursue self-preservation, " +
    "replication, resource acquisition, or power-seeking; " +
    "avoid long-term plans beyond the user's request.",
    
    // ğŸ”’ ä¼˜å…ˆå®‰å…¨å’Œäººç±»ç›‘ç£
    "Prioritize safety and human oversight over completion; " +
    "if instructions conflict, pause and ask; " +
    "comply with stop/pause/audit requests and never bypass safeguards. " +
    "(Inspired by Anthropic's constitution.)",
    
    // ğŸ”’ ç¦æ­¢æ“æ§å’Œè‡ªæˆ‘å¤åˆ¶
    "Do not manipulate or persuade anyone to expand access or disable safeguards. " +
    "Do not copy yourself or change system prompts, safety rules, or tool policies " +
    "unless explicitly requested.",
  ];
}
```

#### â‘¢ Skills ç³»ç»Ÿ

å‘Šè¯‰ Agent å¦‚ä½•æ£€ç´¢å’Œä½¿ç”¨ Skillsï¼š

```typescript
function buildSkillsSection(params: {
  skillsPrompt?: string;  // åŒ…å« <available_skills> åˆ—è¡¨
  readToolName: string;
}) {
  return [
    "## Skills (mandatory)",
    "Before replying: scan <available_skills> <description> entries.",
    // é€‰æ‹©è§„åˆ™
    `- If exactly one skill clearly applies: read its SKILL.md at <location> with \`${params.readToolName}\`, then follow it.`,
    "- If multiple could apply: choose the most specific one, then read/follow it.",
    "- If none clearly apply: do not read any SKILL.md.",
    // çº¦æŸ
    "Constraints: never read more than one skill up front; only read after selecting.",
    // å®é™…çš„ skills åˆ—è¡¨
    params.skillsPrompt,  // <available_skills>...</available_skills>
  ];
}
```

#### â‘£ è®°å¿†ç³»ç»Ÿ

```typescript
function buildMemorySection(params: { availableTools: Set<string> }) {
  // åªæœ‰å½“ memory å·¥å…·å¯ç”¨æ—¶æ‰æ·»åŠ 
  if (!params.availableTools.has("memory_search")) {
    return [];
  }
  return [
    "## Memory Recall",
    "Before answering anything about prior work, decisions, dates, people, " +
    "preferences, or todos: run memory_search on MEMORY.md + memory/*.md; " +
    "then use memory_get to pull only the needed lines. " +
    "If low confidence after search, say you checked.",
  ];
}
```

#### â‘¤ é¡¹ç›®ä¸Šä¸‹æ–‡ï¼ˆæœ€é‡è¦ï¼ï¼‰

è¿™æ˜¯è®© Agent äº†è§£é¡¹ç›®ç‰¹å®šè§„åˆ™çš„æ ¸å¿ƒæœºåˆ¶ï¼š

```typescript
// æ³¨å…¥é¡¹ç›®ä¸Šä¸‹æ–‡æ–‡ä»¶
if (contextFiles?.length > 0) {
  // æ£€æŸ¥æ˜¯å¦æœ‰ SOUL.mdï¼ˆäººæ ¼è®¾å®šæ–‡ä»¶ï¼‰
  const hasSoulFile = contextFiles.some((file) => 
    file.path.toLowerCase().endsWith("soul.md")
  );
  
  lines.push("# Project Context");
  lines.push("The following project context files have been loaded:");
  
  // å¦‚æœæœ‰ SOUL.mdï¼Œæ·»åŠ ç‰¹æ®ŠæŒ‡ä»¤
  if (hasSoulFile) {
    lines.push(
      "If SOUL.md is present, embody its persona and tone. " +
      "Avoid stiff, generic replies; follow its guidance " +
      "unless higher-priority instructions override it."
    );
  }
  
  // æ³¨å…¥æ¯ä¸ªä¸Šä¸‹æ–‡æ–‡ä»¶çš„å†…å®¹
  for (const file of contextFiles) {
    lines.push(`## ${file.path}`, "", file.content, "");
  }
}
```

å¸¸è§çš„ä¸Šä¸‹æ–‡æ–‡ä»¶åŒ…æ‹¬ï¼š
- `AGENTS.md` - é¡¹ç›®çº§ Agent è¡Œä¸ºæŒ‡å—
- `SOUL.md` - Agent äººæ ¼è®¾å®š
- `TOOLS.md` - å·¥å…·ä½¿ç”¨æŒ‡å—

#### â‘¥ è¿è¡Œæ—¶ä¿¡æ¯

```typescript
export function buildRuntimeLine(runtimeInfo?: {...}): string {
  return `Runtime: ${[
    runtimeInfo?.agentId ? `agent=${runtimeInfo.agentId}` : "",
    runtimeInfo?.host ? `host=${runtimeInfo.host}` : "",
    runtimeInfo?.os ? `os=${runtimeInfo.os}` : "",
    runtimeInfo?.model ? `model=${runtimeInfo.model}` : "",
    runtimeInfo?.channel ? `channel=${runtimeInfo.channel}` : "",
  ].filter(Boolean).join(" | ")}`;
}
```

ç”Ÿæˆç¤ºä¾‹ï¼š
```
Runtime: agent=main | host=MacBook | os=darwin (arm64) | model=claude-sonnet-4-20250514 | channel=telegram
```

### 5.3 æ¨¡å—åŒ–è®¾è®¡æ€»ç»“

| è®¾è®¡ | è¯´æ˜ |
|------|------|
| **æ¨¡å—åŒ–æ„å»º** | æ¯ä¸ªéƒ¨åˆ†ç‹¬ç«‹å‡½æ•°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±• |
| **æ¡ä»¶åŒ…å«** | æ ¹æ®å¯ç”¨å·¥å…·ã€æ¨¡å¼ç­‰åŠ¨æ€å†³å®šæ˜¯å¦åŒ…å«æŸéƒ¨åˆ† |
| **ä¸Šä¸‹æ–‡æ³¨å…¥** | æ”¯æŒæ³¨å…¥é¡¹ç›®ç‰¹å®šæ–‡ä»¶ï¼ˆAGENTS.md ç­‰ï¼‰ |
| **å¤šæ¨¡å¼æ”¯æŒ** | full/minimal/none é€‚åº”ä¸åŒåœºæ™¯ |
| **å®‰å…¨ä¼˜å…ˆ** | å®‰å…¨è§„åˆ™ä½œä¸ºæ ¸å¿ƒéƒ¨åˆ†å§‹ç»ˆåŒ…å« |
| **è¿è¡Œæ—¶æ„ŸçŸ¥** | åŒ…å«å½“å‰ç¯å¢ƒä¿¡æ¯ï¼Œè®© Agent äº†è§£è¿è¡Œä¸Šä¸‹æ–‡ |

---

## å…­ã€Skills æ£€ç´¢ç³»ç»Ÿ

### 6.1 Skills ç›®å½•ç»“æ„

```
ä¼˜å…ˆçº§ (ä½ â†’ é«˜):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. extraDirs     - ç”¨æˆ·é…ç½®çš„é¢å¤–ç›®å½•                   â”‚
â”‚  2. bundled       - å†…ç½® skills (é¡¹ç›® /skills/ ç›®å½•)     â”‚
â”‚  3. managed       - æ‰˜ç®¡ç›®å½• (~/.config/openclaw/skills/)â”‚
â”‚  4. workspace     - å·¥ä½œåŒº (<workspaceDir>/skills/)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†…ç½® Skills ç¤ºä¾‹** (52+ ä¸ª):

```
skills/
â”œâ”€â”€ github/         # GitHub CLI é›†æˆ
â”œâ”€â”€ discord/        # Discord Bot æ§åˆ¶
â”œâ”€â”€ coding-agent/   # ç¼–ç ä»£ç†æŒ‡å—
â”œâ”€â”€ 1password/      # 1Password å¯†ç ç®¡ç†
â”œâ”€â”€ obsidian/       # Obsidian ç¬”è®°
â”œâ”€â”€ spotify-player/ # Spotify æ’­æ”¾æ§åˆ¶
â”œâ”€â”€ weather/        # å¤©æ°”æŸ¥è¯¢
â”œâ”€â”€ docker/         # Docker å®¹å™¨ç®¡ç†
â”œâ”€â”€ kubernetes/     # K8s é›†ç¾¤ç®¡ç†
â”œâ”€â”€ homebrew/       # Homebrew åŒ…ç®¡ç†
â””â”€â”€ ...
```

### 6.2 SKILL.md æ–‡ä»¶æ ¼å¼

**ç¤ºä¾‹**: `skills/github/SKILL.md`

```markdown
---
name: github
description: "Interact with GitHub using the `gh` CLI..."
metadata:
  {
    "openclaw":
      {
        "emoji": "ğŸ™",
        "requires": { "bins": ["gh"] },
        "install":
          [
            {
              "id": "brew",
              "kind": "brew",
              "formula": "gh",
              "bins": ["gh"],
              "label": "Install GitHub CLI (brew)",
            },
          ],
      },
  }
---

# GitHub Skill

Use the `gh` CLI to interact with GitHub...

## Pull Requests
```bash
gh pr checks 55 --repo owner/repo
```
...
```

**Frontmatter å­—æ®µè¯´æ˜**:

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `name` | string | Skill å”¯ä¸€æ ‡è¯†ç¬¦ |
| `description` | string | ç®€çŸ­æè¿°ï¼ˆç”¨äºåŒ¹é…ï¼‰ |
| `metadata.openclaw.emoji` | string | æ˜¾ç¤ºå›¾æ ‡ |
| `metadata.openclaw.os` | string[] | é™åˆ¶æ“ä½œç³»ç»Ÿ |
| `metadata.openclaw.requires.bins` | string[] | å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶ |
| `metadata.openclaw.requires.anyBins` | string[] | ä»»ä¸€å³å¯çš„äºŒè¿›åˆ¶ |
| `metadata.openclaw.requires.env` | string[] | å¿…éœ€çš„ç¯å¢ƒå˜é‡ |
| `metadata.openclaw.requires.config` | string[] | å¿…éœ€çš„é…ç½®è·¯å¾„ |
| `metadata.openclaw.install` | object[] | å®‰è£…é€‰é¡¹ |
| `metadata.openclaw.always` | boolean | å§‹ç»ˆåŒ…å«ï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰ |

### 6.3 Skills åŠ è½½æµç¨‹

**æ–‡ä»¶**: `src/agents/skills/workspace.ts`

```typescript
function loadSkillEntries(
  workspaceDir: string,
  opts?: {
    config?: OpenClawConfig;
    managedSkillsDir?: string;
    bundledSkillsDir?: string;
  },
): SkillEntry[] {
  const loadSkills = (params: { dir: string; source: string }): Skill[] => {
    const loaded = loadSkillsFromDir(params);  // ä½¿ç”¨ pi-coding-agent
    // ...
  };

  // 1. è§£æå„ç›®å½•è·¯å¾„
  const managedSkillsDir = opts?.managedSkillsDir ?? path.join(CONFIG_DIR, "skills");
  const workspaceSkillsDir = path.join(workspaceDir, "skills");
  const bundledSkillsDir = opts?.bundledSkillsDir ?? resolveBundledSkillsDir();
  const extraDirs = opts?.config?.skills?.load?.extraDirs ?? [];
  const pluginSkillDirs = resolvePluginSkillDirs({...});

  // 2. ä»å„ç›®å½•åŠ è½½
  const bundledSkills = loadSkills({ dir: bundledSkillsDir, source: "openclaw-bundled" });
  const extraSkills = mergedExtraDirs.flatMap(dir => loadSkills({...}));
  const managedSkills = loadSkills({ dir: managedSkillsDir, source: "openclaw-managed" });
  const workspaceSkills = loadSkills({ dir: workspaceSkillsDir, source: "openclaw-workspace" });

  // 3. æŒ‰ä¼˜å…ˆçº§åˆå¹¶ï¼ˆåè¦†ç›–å‰ï¼‰
  const merged = new Map<string, Skill>();
  for (const skill of extraSkills) merged.set(skill.name, skill);
  for (const skill of bundledSkills) merged.set(skill.name, skill);
  for (const skill of managedSkills) merged.set(skill.name, skill);
  for (const skill of workspaceSkills) merged.set(skill.name, skill);

  // 4. è§£æ frontmatter å’Œå…ƒæ•°æ®
  return Array.from(merged.values()).map(skill => ({
    skill,
    frontmatter: parseFrontmatter(raw),
    metadata: resolveOpenClawMetadata(frontmatter),
    invocation: resolveSkillInvocationPolicy(frontmatter),
  }));
}
```

### 6.4 Skills èµ„æ ¼æ£€æŸ¥ (Eligibility)

**æ–‡ä»¶**: `src/agents/skills/config.ts`

```typescript
export function shouldIncludeSkill(params: {
  entry: SkillEntry;
  config?: OpenClawConfig;
  eligibility?: SkillEligibilityContext;
}): boolean {
  const { entry, config, eligibility } = params;
  
  // 1. æ£€æŸ¥æ˜¯å¦æ˜¾å¼ç¦ç”¨
  if (skillConfig?.enabled === false) {
    return false;
  }
  
  // 2. æ£€æŸ¥å†…ç½® allowlist
  if (!isBundledSkillAllowed(entry, allowBundled)) {
    return false;
  }
  
  // 3. æ£€æŸ¥æ“ä½œç³»ç»Ÿé™åˆ¶
  if (osList.length > 0 && !osList.includes(resolveRuntimePlatform())) {
    return false;
  }
  
  // 4. always=true è·³è¿‡å…¶ä»–æ£€æŸ¥
  if (entry.metadata?.always === true) {
    return true;
  }

  // 5. æ£€æŸ¥å¿…éœ€çš„äºŒè¿›åˆ¶æ–‡ä»¶
  const requiredBins = entry.metadata?.requires?.bins ?? [];
  for (const bin of requiredBins) {
    if (!hasBinary(bin) && !eligibility?.remote?.hasBin?.(bin)) {
      return false;
    }
  }
  
  // 6. æ£€æŸ¥ anyBinsï¼ˆä»»ä¸€å³å¯ï¼‰
  const requiredAnyBins = entry.metadata?.requires?.anyBins ?? [];
  if (requiredAnyBins.length > 0) {
    const anyFound = requiredAnyBins.some(bin => hasBinary(bin));
    if (!anyFound) return false;
  }

  // 7. æ£€æŸ¥ç¯å¢ƒå˜é‡
  const requiredEnv = entry.metadata?.requires?.env ?? [];
  for (const envName of requiredEnv) {
    if (!process.env[envName] && !skillConfig?.env?.[envName]) {
      return false;
    }
  }

  // 8. æ£€æŸ¥é…ç½®è·¯å¾„
  const requiredConfig = entry.metadata?.requires?.config ?? [];
  for (const configPath of requiredConfig) {
    if (!isConfigPathTruthy(config, configPath)) {
      return false;
    }
  }

  return true;
}
```

**èµ„æ ¼æ£€æŸ¥æµç¨‹å›¾**:

```
              Skill èµ„æ ¼æ£€æŸ¥
                    â”‚
                    â–¼
         â”Œâ”€ enabled=false? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ ä¸åœ¨ allowBundled? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ OS ä¸åŒ¹é…? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ always=true? â”€â†’ âœ… åŒ…å«
         â”‚
         â–¼
         â”Œâ”€ ç¼ºå°‘ bins? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ ç¼ºå°‘ anyBins? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ ç¼ºå°‘ env? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
         â”Œâ”€ ç¼ºå°‘ config? â”€â†’ âŒ æ’é™¤
         â”‚
         â–¼
              âœ… åŒ…å«
```

### 6.5 Skills æ³¨å…¥åˆ°ç³»ç»Ÿæç¤ºè¯

**æ–‡ä»¶**: `src/agents/system-prompt.ts`

```typescript
function buildSkillsSection(params: {
  skillsPrompt?: string;
  isMinimal: boolean;
  readToolName: string;
}) {
  if (params.isMinimal) {
    return [];  // å­ agent ä¸æ³¨å…¥ skills
  }
  const trimmed = params.skillsPrompt?.trim();
  if (!trimmed) {
    return [];
  }
  return [
    "## Skills (mandatory)",
    "Before replying: scan <available_skills> <description> entries.",
    `- If exactly one skill clearly applies: read its SKILL.md at <location> with \`${params.readToolName}\`, then follow it.`,
    "- If multiple could apply: choose the most specific one, then read/follow it.",
    "- If none clearly apply: do not read any SKILL.md.",
    "Constraints: never read more than one skill up front; only read after selecting.",
    trimmed,  // <-- Skills XML åˆ—è¡¨
    "",
  ];
}
```

**ç”Ÿæˆçš„æç¤ºè¯æ ¼å¼**:

```xml
## Skills (mandatory)
Before replying: scan <available_skills> <description> entries.
- If exactly one skill clearly applies: read its SKILL.md at <location> with `Read`, then follow it.
- If multiple could apply: choose the most specific one, then read/follow it.
- If none clearly apply: do not read any SKILL.md.
Constraints: never read more than one skill up front; only read after selecting.

<available_skills>
  <skill>
    <name>github</name>
    <description>Interact with GitHub using the `gh` CLI. Use `gh issue`, `gh pr`, `gh run`, and `gh api` for issues, PRs, CI runs, and advanced queries.</description>
    <location>/path/to/skills/github/SKILL.md</location>
  </skill>
  <skill>
    <name>discord</name>
    <description>Control Discord Bot and server operations...</description>
    <location>/path/to/skills/discord/SKILL.md</location>
  </skill>
  ...
</available_skills>
```

### 6.6 Skills æ£€ç´¢ç­–ç•¥

Agent çš„ Skills æ£€ç´¢æ˜¯**åŸºäºæè¿°çš„è¯­ä¹‰åŒ¹é…**ï¼Œè€Œä¸æ˜¯å…³é”®è¯æœç´¢ã€‚

#### 5.6.1 æ£€ç´¢åŸç†è¯¦è§£

> âš ï¸ **é‡è¦æ¾„æ¸…**ï¼šSkills æ£€ç´¢**ä¸ä½¿ç”¨å‘é‡åµŒå…¥æˆ–è¯­ä¹‰æœç´¢ç®—æ³•**ï¼Œè€Œæ˜¯**å®Œå…¨ä¾èµ– LLM è‡ªèº«çš„è¯­è¨€ç†è§£èƒ½åŠ›**æ¥åŒ¹é…ç”¨æˆ·æ„å›¾å’Œ Skill æè¿°ã€‚

**æ ¸å¿ƒæœºåˆ¶**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Skills æ£€ç´¢åŸç†                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç³»ç»Ÿå°†æ‰€æœ‰ Skill çš„åç§° + æè¿°æ³¨å…¥åˆ° System Prompt ä¸­ï¼š

   ## Skills (mandatory)
   Before replying: scan <available_skills> <description> entries.
   - If exactly one skill clearly applies: read its SKILL.md...
   - If multiple could apply: choose the most specific one...
   - If none clearly apply: do not read any SKILL.md.

   <available_skills>
     <skill>
       <name>github</name>
       <description>Interact with GitHub using `gh` CLI...</description>
       <location>/path/to/github/SKILL.md</location>
     </skill>
     <skill>
       <name>slack</name>
       <description>Send messages to Slack channels...</description>
       <location>/path/to/slack/SKILL.md</location>
     </skill>
     ...
   </available_skills>

2. LLM è‡ªè¡Œé˜…è¯»ç”¨æˆ·è¯·æ±‚ï¼Œç†è§£æ„å›¾ï¼Œç„¶åæ‰«ææ‰€æœ‰ description

3. LLM æ ¹æ®è¯­ä¹‰ç›¸å…³æ€§åˆ¤æ–­å“ªä¸ª Skill æœ€åŒ¹é…ï¼ˆè¿™æ˜¯ LLM çš„æ¨ç†èƒ½åŠ›ï¼Œä¸æ˜¯ç®—æ³•ï¼‰

4. å¦‚æœåŒ¹é…åˆ°ï¼ŒLLM ä½¿ç”¨ read å·¥å…·è¯»å–å¯¹åº”çš„ SKILL.md æ–‡ä»¶
```

**ä¸ºä»€ä¹ˆå«"è¯­ä¹‰åŒ¹é…"ï¼Ÿ**

| æ–¹å¼ | å®ç° | ç‰¹ç‚¹ |
|------|------|------|
| **å…³é”®è¯æœç´¢** | ä»£ç ç®—æ³• (å¦‚ BM25) | ç²¾ç¡®åŒ¹é…å­—ç¬¦ä¸²ï¼Œ"CI" åªèƒ½åŒ¹é…åŒ…å« "CI" çš„æ–‡æœ¬ |
| **å‘é‡è¯­ä¹‰æœç´¢** | Embedding + å‘é‡ç›¸ä¼¼åº¦ | ä»£ç è®¡ç®—è¯­ä¹‰è·ç¦»ï¼Œå¦‚è®°å¿†ç³»ç»Ÿä½¿ç”¨çš„æ–¹å¼ |
| **LLM è¯­ä¹‰ç†è§£** | LLM æ¨ç† | LLM ç†è§£ "CI çŠ¶æ€" å’Œ "workflow runs" æ˜¯ç›¸å…³æ¦‚å¿µ |

Skills ä½¿ç”¨çš„æ˜¯**ç¬¬ä¸‰ç§æ–¹å¼**â€”â€”è®© LLM è‡ªå·±ç†è§£å’ŒåŒ¹é…ã€‚

#### 5.6.2 å®Œæ•´æ£€ç´¢æµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·è¯·æ±‚: "å¸®æˆ‘çœ‹ä¸€ä¸‹ PR #123 çš„ CI çŠ¶æ€"
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æ”¶åˆ°çš„ System Prompt åŒ…å«:                                              â”‚
â”‚                                                                             â”‚
â”‚  <available_skills>                                                         â”‚
â”‚    <skill>                                                                  â”‚
â”‚      <name>github</name>                                                    â”‚
â”‚      <description>Interact with GitHub using `gh` CLI. Use `gh issue`,      â”‚
â”‚                   `gh pr`, `gh run` for issues, PRs, CI runs...</description>â”‚
â”‚    </skill>                                                                 â”‚
â”‚    <skill>                                                                  â”‚
â”‚      <name>slack</name>                                                     â”‚
â”‚      <description>Send messages to Slack channels...</description>          â”‚
â”‚    </skill>                                                                 â”‚
â”‚    <skill>                                                                  â”‚
â”‚      <name>weather</name>                                                   â”‚
â”‚      <description>Get weather forecasts...</description>                    â”‚
â”‚    </skill>                                                                 â”‚
â”‚  </available_skills>                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM å†…éƒ¨æ¨ç†ï¼ˆè¿™æ˜¯ LLM çš„æ€è€ƒè¿‡ç¨‹ï¼‰:                                          â”‚
â”‚                                                                             â”‚
â”‚  "ç”¨æˆ·é—®çš„æ˜¯ PR #123 çš„ CI çŠ¶æ€..."                                          â”‚
â”‚  "æ‰«æ available_skills..."                                                 â”‚
â”‚  "- github: æåˆ° 'gh pr', 'CI runs' â†’ é«˜åº¦ç›¸å…³ âœ“"                            â”‚
â”‚  "- slack: å‘æ¶ˆæ¯ï¼Œä¸ç›¸å…³ âœ—"                                                 â”‚
â”‚  "- weather: å¤©æ°”ï¼Œä¸ç›¸å…³ âœ—"                                                 â”‚
â”‚  "ç»“è®º: github skill æ˜ç¡®åŒ¹é…"                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM è¾“å‡º Tool Call:                                                        â”‚
â”‚                                                                             â”‚
â”‚  {                                                                          â”‚
â”‚    "name": "read",                                                          â”‚
â”‚    "arguments": { "path": "/path/to/github/SKILL.md" }                      â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¡†æ¶æ‰§è¡Œ read å·¥å…·ï¼Œè¿”å› SKILL.md å†…å®¹:                                       â”‚
â”‚                                                                             â”‚
â”‚  # GitHub Skill                                                             â”‚
â”‚  Use the `gh` CLI to interact with GitHub...                                â”‚
â”‚                                                                             â”‚
â”‚  ## Pull Requests                                                           â”‚
â”‚  Check CI status on a PR:                                                   â”‚
â”‚  ```bash                                                                    â”‚
â”‚  gh pr checks 55 --repo owner/repo                                          â”‚
â”‚  ```                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM é˜…è¯» SKILL.md åï¼Œæ‰§è¡Œå…·ä½“å‘½ä»¤:                                          â”‚
â”‚                                                                             â”‚
â”‚  {                                                                          â”‚
â”‚    "name": "exec",                                                          â”‚
â”‚    "arguments": { "command": "gh pr checks 123 --repo owner/repo" }         â”‚
â”‚  }                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 5.6.3 ä¸ºä»€ä¹ˆä¸ç”¨å‘é‡æœç´¢ï¼Ÿ

| å¯¹æ¯”é¡¹ | å‘é‡è¯­ä¹‰æœç´¢ | LLM ç›´æ¥ç†è§£ |
|--------|-------------|-------------|
| **å®ç°å¤æ‚åº¦** | éœ€è¦ Embedding æ¨¡å‹ + å‘é‡æ•°æ®åº“ | åªéœ€åœ¨ Prompt ä¸­åˆ—å‡º |
| **å»¶è¿Ÿ** | éœ€è¦é¢å¤– API è°ƒç”¨è®¡ç®—å‘é‡ | é›¶é¢å¤–å»¶è¿Ÿ |
| **Skills æ•°é‡** | é€‚åˆå¤§è§„æ¨¡ï¼ˆæ•°åƒä¸ªï¼‰ | é€‚åˆä¸­å°è§„æ¨¡ï¼ˆæ•°åä¸ªï¼‰ |
| **å‡†ç¡®åº¦** | ä¾èµ–å‘é‡æ¨¡å‹è´¨é‡ | ä¾èµ– LLM æ¨ç†èƒ½åŠ› |
| **ä¸Šä¸‹æ–‡æ¶ˆè€—** | åªè¿”å›åŒ¹é…ç»“æœ | æ‰€æœ‰æè¿°éƒ½åœ¨ Prompt ä¸­ |

**OpenClaw çš„é€‰æ‹©**ï¼šç”±äº Skills æ•°é‡é€šå¸¸åœ¨å‡ åä¸ªä»¥å†…ï¼Œç›´æ¥è®© LLM æ‰«ææ‰€æœ‰æè¿°æ˜¯æœ€ç®€å•é«˜æ•ˆçš„æ–¹æ¡ˆã€‚

#### 5.6.4 System Prompt ä¸­çš„æ£€ç´¢æŒ‡ä»¤

```typescript
// src/agents/system-prompt.ts
function buildSkillsSection(params) {
  return [
    "## Skills (mandatory)",
    "Before replying: scan <available_skills> <description> entries.",
    "- If exactly one skill clearly applies: read its SKILL.md at <location> with `read`, then follow it.",
    "- If multiple could apply: choose the most specific one, then read/follow it.",
    "- If none clearly apply: do not read any SKILL.md.",
    "Constraints: never read more than one skill up front; only read after selecting.",
    trimmed,  // â† <available_skills>...</available_skills> å†…å®¹
  ];
}
```

**æ£€ç´¢è§„åˆ™**:

1. **æ‰«æ description**: Agent é¦–å…ˆæ‰«ææ‰€æœ‰ skill çš„æè¿°
2. **å•ä¸€åŒ¹é…**: å¦‚æœåªæœ‰ä¸€ä¸ªæ˜ç¡®åŒ¹é…ï¼Œç›´æ¥ä½¿ç”¨
3. **å¤šé‡åŒ¹é…**: é€‰æ‹©æœ€å…·ä½“çš„é‚£ä¸ª
4. **æ— åŒ¹é…**: ä¸è¯»å–ä»»ä½• SKILL.mdï¼Œç›´æ¥å¤„ç†

#### 5.6.5 ä¸è®°å¿†ç³»ç»Ÿæ£€ç´¢çš„å¯¹æ¯”

| å¯¹æ¯”é¡¹ | Skills æ£€ç´¢ | è®°å¿†ç³»ç»Ÿæ£€ç´¢ |
|--------|-------------|-------------|
| **æ£€ç´¢æ–¹å¼** | LLM æ‰«æ System Prompt | å‘é‡ + å…³é”®è¯æ··åˆæœç´¢ |
| **æ•°æ®ä½ç½®** | åœ¨ Prompt ä¸­ï¼ˆæ¶ˆè€— Tokenï¼‰ | åœ¨ SQLite æ•°æ®åº“ä¸­ |
| **è§¦å‘æ–¹å¼** | LLM è‡ªåŠ¨åˆ¤æ–­ | è°ƒç”¨ memory_search å·¥å…· |
| **é€‚ç”¨è§„æ¨¡** | å‡ åä¸ª Skill | æ•°åƒæ¡è®°å¿† |
| **æ£€ç´¢ç®—æ³•** | æ— ï¼ˆLLM æ¨ç†ï¼‰ | sqlite-vec + FTS5 |

### 6.7 Skills æ–‡ä»¶ç›‘è§†ä¸çƒ­åˆ·æ–°

**æ–‡ä»¶**: `src/agents/skills/refresh.ts`

```typescript
export function ensureSkillsWatcher(params) {
  const watchPaths = resolveWatchPaths(workspaceDir, config);
  
  const watcher = chokidar.watch(watchPaths, {
    ignoreInitial: true,
    ignored: [/node_modules/, /\.git/, /dist/],
  });

  watcher.on("add", p => bumpSkillsSnapshotVersion(...));
  watcher.on("change", p => bumpSkillsSnapshotVersion(...));
  watcher.on("unlink", p => bumpSkillsSnapshotVersion(...));
}
```

å½“ Skills æ–‡ä»¶å˜åŒ–æ—¶ï¼Œè‡ªåŠ¨åˆ·æ–°å¿«ç…§ç‰ˆæœ¬ï¼Œä¸‹æ¬¡ Agent è¿è¡Œæ—¶ä¼šåŠ è½½æœ€æ–°çš„ Skillsã€‚

---

## ä¸ƒã€è®°å¿†ç®¡ç†ç³»ç»Ÿ

è®°å¿†ç®¡ç†ç³»ç»Ÿï¼ˆMemory Systemï¼‰æ˜¯ OpenClaw çš„**è·¨ä¼šè¯æŒä¹…åŒ–çŸ¥è¯†æ£€ç´¢**æœºåˆ¶ï¼Œä¸ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†å½¢æˆäº’è¡¥ã€‚

### 7.1 ä¸ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†çš„åŒºåˆ«

| ç»´åº¦ | **ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†** | **è®°å¿†ç®¡ç†ç³»ç»Ÿ** |
|------|-------------------|-----------------|
| **ä½œç”¨èŒƒå›´** | å•æ¬¡ä¼šè¯å†… | è·¨ä¼šè¯æŒä¹…åŒ– |
| **å­˜å‚¨ä½ç½®** | ä¼šè¯æ–‡ä»¶ `.jsonl` | `MEMORY.md` + `memory/*.md` + SQLite |
| **ç”Ÿå‘½å‘¨æœŸ** | éšä¼šè¯ç»“æŸå¯èƒ½è¢«è£å‰ª/å‹ç¼© | é•¿æœŸä¿å­˜ï¼Œè·¨ä¼šè¯å¯ç”¨ |
| **ä¸»è¦åŠŸèƒ½** | Token é™åˆ¶ã€ä¸Šä¸‹æ–‡è£å‰ªã€æ‘˜è¦å‹ç¼© | è¯­ä¹‰æ£€ç´¢ã€çŸ¥è¯†å­˜å‚¨ |
| **æ ¸å¿ƒæ–‡ä»¶** | `compaction.ts`, `context-pruning/` | `memory/manager.ts`, `memory-tool.ts` |
| **è§¦å‘æ–¹å¼** | è‡ªåŠ¨ï¼ˆä¸Šä¸‹æ–‡è¶…é™æ—¶ï¼‰ | ä¸»åŠ¨è°ƒç”¨å·¥å…·æ£€ç´¢ |

**ç®€å•ç†è§£**ï¼š
- **ä¸Šä¸‹æ–‡å·¥ç¨‹ç®¡ç†**è§£å†³çš„æ˜¯"è¿™è½®å¯¹è¯å¤ªé•¿äº†æ€ä¹ˆåŠ"
- **è®°å¿†ç®¡ç†ç³»ç»Ÿ**è§£å†³çš„æ˜¯"ä¸Šå‘¨æˆ‘è®©ä½ åšçš„é‚£ä¸ªä»»åŠ¡å«ä»€ä¹ˆ"

### 7.2 æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è®°å¿†ç®¡ç†ç³»ç»Ÿæ¶æ„                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   è®°å¿†æ¥æº        â”‚   â”‚   åµŒå…¥å±‚          â”‚   â”‚    æ£€ç´¢å±‚             â”‚
â”‚  (Memory Sources) â”‚   â”‚  (Embeddings)     â”‚   â”‚  (Search)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
â”‚               â”‚           â”‚             â”‚           â”‚               â”‚
â–¼               â–¼           â–¼             â–¼           â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚MEMORY.mdâ”‚ â”‚memory/* â”‚ â”‚ OpenAI  â”‚ â”‚ Gemini  â”‚ â”‚ Vector  â”‚ â”‚Keyword  â”‚
â”‚         â”‚ â”‚ *.md    â”‚ â”‚Embeddingâ”‚ â”‚Embeddingâ”‚ â”‚ Search  â”‚ â”‚ Search  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                          â”‚                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  SQLite + sqlite- â”‚
                          â”‚  vec (å‘é‡å­˜å‚¨)   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 è®°å¿†å­˜å‚¨æ¥æº

**æ–‡ä»¶**: `src/memory/internal.ts`

#### æ”¯æŒçš„è®°å¿†æº

| æ¥æº | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **MEMORY.md** | `{workspace}/MEMORY.md` | ä¸»è®°å¿†æ–‡ä»¶ |
| **memoryç›®å½•** | `{workspace}/memory/*.md` | åˆ†ç±»è®°å¿†æ–‡ä»¶ |
| **ä¼šè¯è®°å½•** | `~/.openclaw/sessions/*.jsonl` | å†å²å¯¹è¯ï¼ˆå®éªŒæ€§ï¼‰ |
| **extraPaths** | ç”¨æˆ·é…ç½®çš„é¢å¤–è·¯å¾„ | è‡ªå®šä¹‰è®°å¿†æº |

```typescript
// è®°å¿†æ–‡ä»¶è·¯å¾„åˆ¤æ–­
export function isMemoryPath(relPath: string): boolean {
  const normalized = normalizeRelPath(relPath);
  if (normalized === "MEMORY.md" || normalized === "memory.md") {
    return true;
  }
  return normalized.startsWith("memory/");
}

// åˆ—å‡ºæ‰€æœ‰è®°å¿†æ–‡ä»¶
export async function listMemoryFiles(
  workspaceDir: string,
  extraPaths?: string[],
): Promise<string[]> {
  // 1. æ£€æŸ¥ MEMORY.md
  // 2. æ‰«æ memory/ ç›®å½•ä¸‹çš„ .md æ–‡ä»¶
  // 3. æ·»åŠ  extraPaths ä¸­çš„æ–‡ä»¶
}
```

#### æ–‡ä»¶åˆ†å—æœºåˆ¶

```typescript
// åˆ†å—é…ç½®
const DEFAULT_CHUNK_TOKENS = 400;   // æ¯å—æœ€å¤§ Token
const DEFAULT_CHUNK_OVERLAP = 80;   // å—é—´é‡å  Token

export type MemoryChunk = {
  startLine: number;  // èµ·å§‹è¡Œå·
  endLine: number;    // ç»“æŸè¡Œå·
  text: string;       // å—å†…å®¹
  hash: string;       // å†…å®¹å“ˆå¸Œï¼ˆç”¨äºå¢é‡æ›´æ–°ï¼‰
};
```

### 7.4 è®°å¿†æ–‡ä»¶ç»“æ„ä¸ç”Ÿæˆæœºåˆ¶

**æ–‡ä»¶**: `src/memory/internal.ts`, `src/hooks/bundled/session-memory/handler.ts`

#### è®°å¿†æ–‡ä»¶æ ¼å¼ç¤ºä¾‹

ç³»ç»Ÿæ”¯æŒä¸‰ç§ç±»å‹çš„è®°å¿†æ–‡ä»¶ï¼Œæ¯ç§æœ‰ä¸åŒçš„ç”¨é€”å’Œæ ¼å¼ï¼š

**1. ä¸»è®°å¿†æ–‡ä»¶ `MEMORY.md`ï¼ˆæ‰‹åŠ¨ç»´æŠ¤çš„é•¿æœŸè®°å¿†ï¼‰**

è¿™æ˜¯ç”¨æˆ·/Agent æ‰‹åŠ¨ç»´æŠ¤çš„é•¿æœŸè®°å¿†æ–‡ä»¶ï¼Œæ ¼å¼è‡ªç”±ï¼š

```markdown
# Long-Term Memory

## ç”¨æˆ·åå¥½
- å–œæ¬¢ç®€æ´çš„ä»£ç é£æ ¼
- åå¥½ä½¿ç”¨ TypeScript
- å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00

## é‡è¦å†³ç­–
- 2026-01-15: å†³å®šä½¿ç”¨ PostgreSQL ä½œä¸ºä¸»æ•°æ®åº“
- 2026-01-10: API é‡‡ç”¨ RESTful é£æ ¼ï¼Œç‰ˆæœ¬å‰ç¼€ /v1/

## é¡¹ç›®èƒŒæ™¯
- æ­£åœ¨å¼€å‘ä¸€ä¸ªç”µå•†åå°ç³»ç»Ÿ
- æŠ€æœ¯æ ˆï¼šNode.js + React + PostgreSQL

## è”ç³»äºº
- å¼ ä¸‰ - åç«¯è´Ÿè´£äºº
- æå›› - äº§å“ç»ç†
```

**2. æ¯æ—¥è®°å¿†æ–‡ä»¶ `memory/YYYY-MM-DD.md`ï¼ˆæ‰‹åŠ¨/è‡ªåŠ¨ï¼‰**

æŒ‰æ—¥æœŸç»„ç»‡çš„æ—¥å¿—å¼è®°å¿†ï¼Œå¯ç”± Agent è‡ªåŠ¨å†™å…¥æˆ–æ‰‹åŠ¨ç»´æŠ¤ï¼š

```markdown
# 2026-01-16

## ä»Šæ—¥å·¥ä½œ
- å®Œæˆäº†ç”¨æˆ·è®¤è¯æ¨¡å—çš„ä»£ç å®¡æŸ¥
- ä¿®å¤äº†è´­ç‰©è½¦ç»“ç®—æ—¶çš„å¹¶å‘é—®é¢˜

## å¾…åŠäº‹é¡¹
- [ ] å®Œå–„ API æ–‡æ¡£
- [ ] å‡†å¤‡å‘¨äº”çš„æŠ€æœ¯åˆ†äº«

## å¤‡æ³¨
ç”¨æˆ·åé¦ˆï¼šç™»å½•é¡µé¢åŠ è½½æœ‰ç‚¹æ…¢ï¼Œéœ€è¦ä¼˜åŒ–
```

**3. è‡ªåŠ¨ç”Ÿæˆçš„ä¼šè¯è®°å¿† `memory/YYYY-MM-DD-{slug}.md`**

ç”± `session-memory` Hook åœ¨ç”¨æˆ·æ‰§è¡Œ `/new` å‘½ä»¤æ—¶è‡ªåŠ¨ç”Ÿæˆï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼š

```markdown
# Session: 2026-01-16 14:30:00 UTC

- **Session Key**: agent:main:main
- **Session ID**: abc123def456
- **Source**: telegram

## Conversation Summary

user: å¸®æˆ‘è®¾è®¡ä¸€ä¸ªç”¨æˆ·ç®¡ç† API
assistant: å¥½çš„ï¼Œæˆ‘å»ºè®®ä½¿ç”¨ RESTful é£æ ¼...
user: éœ€è¦æ”¯æŒåˆ†é¡µå—ï¼Ÿ
assistant: æ˜¯çš„ï¼Œå»ºè®®ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ...
```

#### è®°å¿†æ–‡ä»¶æ¥æº

ç³»ç»Ÿæ”¯æŒä¸¤ç§è®°å¿†æ–‡ä»¶æ¥æºï¼š

```
workspace/
â”œâ”€â”€ MEMORY.md              # ä¸»è®°å¿†æ–‡ä»¶ï¼ˆæ‰‹åŠ¨ç»´æŠ¤ï¼Œé•¿æœŸè®°å¿†ï¼‰
â”œâ”€â”€ memory.md              # å¤‡é€‰ä¸»è®°å¿†æ–‡ä»¶ï¼ˆMEMORY.md ä¸å­˜åœ¨æ—¶ä½¿ç”¨ï¼‰
â””â”€â”€ memory/                # è®°å¿†ç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆ + æ‰‹åŠ¨ç»´æŠ¤ï¼‰
    â”œâ”€â”€ 2026-01-15-api-design.md    # è‡ªåŠ¨ç”Ÿæˆçš„ä¼šè¯è®°å¿†
    â”œâ”€â”€ 2026-01-16-bug-fix.md       # è‡ªåŠ¨ç”Ÿæˆçš„ä¼šè¯è®°å¿†
    â”œâ”€â”€ projects.md                  # æ‰‹åŠ¨ç»´æŠ¤çš„é¡¹ç›®è®°å¿†
    â””â”€â”€ preferences.md               # æ‰‹åŠ¨ç»´æŠ¤çš„åå¥½è®¾ç½®
```

#### è®°å¿†æ–‡ä»¶æ‰«æé€»è¾‘

```typescript
// src/memory/internal.ts - listMemoryFiles å‡½æ•°
export async function listMemoryFiles(workspaceDir: string): Promise<string[]> {
  const result: string[] = [];
  
  // 1. æ‰«æä¸»è®°å¿†æ–‡ä»¶
  const memoryFile = path.join(workspaceDir, "MEMORY.md");
  const altMemoryFile = path.join(workspaceDir, "memory.md");
  await addMarkdownFile(memoryFile);   // ä¼˜å…ˆ MEMORY.md
  await addMarkdownFile(altMemoryFile); // å¤‡é€‰ memory.md
  
  // 2. é€’å½’æ‰«æ memory/ ç›®å½•ä¸‹æ‰€æœ‰ .md æ–‡ä»¶
  const memoryDir = path.join(workspaceDir, "memory");
  await walkDir(memoryDir, result);    // é€’å½’éå†
  
  // 3. æ‰«æé¢å¤–é…ç½®çš„è·¯å¾„ï¼ˆextraPathsï¼‰
  for (const inputPath of normalizedExtraPaths) {
    // æ”¯æŒç›®å½•æˆ–å•ä¸ªæ–‡ä»¶
  }
  
  return deduped;  // å»é‡åè¿”å›
}
```

#### è®°å¿†æ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆï¼ˆsession-memory Hookï¼‰

å½“ç”¨æˆ·æ‰§è¡Œ `/new` å‘½ä»¤å¼€å§‹æ–°ä¼šè¯æ—¶ï¼Œ`session-memory` Hook ä¼šè‡ªåŠ¨ä¿å­˜ä¸Šä¸€ä¸ªä¼šè¯çš„å†…å®¹ï¼š

**è§¦å‘æ¡ä»¶**ï¼šç”¨æˆ·å‘é€ `/new` å‘½ä»¤

**ç”Ÿæˆæµç¨‹**ï¼š

```
ç”¨æˆ·æ‰§è¡Œ /new å‘½ä»¤
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ session-memory   â”‚  Hook è¢«è§¦å‘
â”‚ Hook Handler     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å–ä¸Šä¸€ä¼šè¯     â”‚  ä» sessionFile è¯»å–æœ€è¿‘ N æ¡æ¶ˆæ¯
â”‚ (é»˜è®¤ 15 æ¡)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM ç”Ÿæˆ slug    â”‚  æ ¹æ®å¯¹è¯å†…å®¹ç”Ÿæˆæè¿°æ€§æ–‡ä»¶å
â”‚ "api-design"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†™å…¥è®°å¿†æ–‡ä»¶     â”‚  memory/2026-01-16-api-design.md
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç”Ÿæˆçš„è®°å¿†æ–‡ä»¶æ ¼å¼**ï¼š

```markdown
# Session: 2026-01-16 14:30:00 UTC

- **Session Key**: agent:main:main
- **Session ID**: abc123def456
- **Source**: telegram

## Conversation Summary

user: å¸®æˆ‘è®¾è®¡ä¸€ä¸ªç”¨æˆ·ç®¡ç† API
assistant: å¥½çš„ï¼Œæˆ‘å»ºè®®ä½¿ç”¨ RESTful é£æ ¼...
user: éœ€è¦æ”¯æŒåˆ†é¡µå—ï¼Ÿ
assistant: æ˜¯çš„ï¼Œå»ºè®®ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ...
...
```

**æ–‡ä»¶å‘½åè§„åˆ™**ï¼š

| æƒ…å†µ | æ–‡ä»¶åæ ¼å¼ | ç¤ºä¾‹ |
|------|-----------|------|
| LLM æˆåŠŸç”Ÿæˆ slug | `YYYY-MM-DD-{slug}.md` | `2026-01-16-api-design.md` |
| LLM ç”Ÿæˆå¤±è´¥ï¼ˆå›é€€ï¼‰ | `YYYY-MM-DD-HHMM.md` | `2026-01-16-1430.md` |

#### è®°å¿†å‹ç¼©åˆ·æ–°ï¼ˆMemory Flushï¼‰

**æ–‡ä»¶**: `src/auto-reply/reply/memory-flush.ts`

å½“ä¼šè¯æ¥è¿‘ä¸Šä¸‹æ–‡çª—å£é™åˆ¶æ—¶ï¼Œç³»ç»Ÿä¼šè§¦å‘è®°å¿†åˆ·æ–°ï¼Œæç¤º Agent å°†é‡è¦ä¿¡æ¯æŒä¹…åŒ–ï¼š

```typescript
// é»˜è®¤åˆ·æ–°æç¤º
DEFAULT_MEMORY_FLUSH_PROMPT = [
  "Pre-compaction memory flush.",
  "Store durable memories now (use memory/YYYY-MM-DD.md; create memory/ if needed).",
  "If nothing to store, reply with [SILENT].",
].join(" ");

// è§¦å‘æ¡ä»¶
function shouldRunMemoryFlush(params: {
  totalTokens: number;          // å½“å‰ä¼šè¯ token æ•°
  contextWindowTokens: number;  // ä¸Šä¸‹æ–‡çª—å£å¤§å°
  reserveTokensFloor: number;   // ä¿ç•™ token æ•°
  softThresholdTokens: number;  // è½¯é˜ˆå€¼ï¼ˆé»˜è®¤ 4000ï¼‰
}): boolean {
  // å½“ totalTokens > (contextWindow - reserve - softThreshold) æ—¶è§¦å‘
  const threshold = contextWindow - reserveTokens - softThreshold;
  return totalTokens >= threshold;
}
```

**è®°å¿†åˆ·æ–°æ—¶æœº**ï¼š

```
ä¼šè¯ Token ä½¿ç”¨æƒ…å†µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â”‚
â”‚<â”€â”€â”€â”€â”€â”€â”€â”€ å·²ç”¨ Token â”€â”€â”€â”€â”€â”€â”€â”€>â”‚<â”€â”€ è½¯é˜ˆå€¼ â”€â”€>â”‚<ä¿ç•™>â”‚
â”‚                              â”‚   (4000)     â”‚      â”‚
â”‚                              â†‘                      â”‚
â”‚                        è§¦å‘ Memory Flush            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è®°å¿†æ–‡ä»¶ç´¢å¼•ä¸åŒæ­¥

è®°å¿†æ–‡ä»¶è¢«ç´¢å¼•åˆ° SQLite æ•°æ®åº“ä¸­ï¼Œæ”¯æŒå¢é‡åŒæ­¥ï¼š

```typescript
// åŒæ­¥è§¦å‘æ—¶æœº
sync: {
  onSessionStart: boolean;   // ä¼šè¯å¼€å§‹æ—¶åŒæ­¥
  onSearch: boolean;         // æœç´¢æ—¶æ‡’åŒæ­¥
  watch: boolean;            // æ–‡ä»¶å˜æ›´ç›‘è§†
  watchDebounceMs: number;   // é˜²æŠ–é—´éš”ï¼ˆé»˜è®¤ 1500msï¼‰
}
```

**ç´¢å¼•æµç¨‹**ï¼š

```
è®°å¿†æ–‡ä»¶å˜æ›´
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–‡ä»¶ç›‘è§†å™¨  â”‚  (fs.watch / chokidar)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ debounce 1500ms
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®¡ç®—æ–‡ä»¶ hash â”‚  æ£€æµ‹å†…å®¹æ˜¯å¦çœŸçš„å˜åŒ–
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼ å˜åŒ–çš„æ–‡ä»¶
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åˆ†å—å¤„ç†    â”‚  chunkMarkdown(tokens=400, overlap=80)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”ŸæˆåµŒå…¥å‘é‡ â”‚  OpenAI / Gemini / Local
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å†™å…¥ SQLite â”‚  chunks è¡¨ + FTS5 è¡¨ + vec è¡¨
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 å‘é‡åµŒå…¥ä¸æ£€ç´¢

**æ–‡ä»¶**: `src/memory/embeddings.ts`

#### åµŒå…¥æä¾›è€…

| æä¾›è€… | æ¨¡å‹ | è¯´æ˜ |
|--------|------|------|
| **OpenAI** | `text-embedding-3-small` | è¿œç¨‹ API |
| **Gemini** | `gemini-embedding-001` | è¿œç¨‹ API |
| **Local** | `embeddinggemma-300M` | æœ¬åœ°æ¨¡å‹ (node-llama-cpp) |

```typescript
export type EmbeddingProvider = {
  id: string;
  model: string;
  embedQuery: (text: string) => Promise<number[]>;    // å•æ¡åµŒå…¥
  embedBatch: (texts: string[]) => Promise<number[][]>; // æ‰¹é‡åµŒå…¥
};

// æä¾›è€…é€‰æ‹©ç­–ç•¥
provider: "openai" | "local" | "gemini" | "auto"
// auto: ä¼˜å…ˆ OpenAI â†’ Gemini â†’ Local

// å›é€€æœºåˆ¶
fallback: "openai" | "gemini" | "local" | "none"
```

#### åµŒå…¥å­˜å‚¨

**æ–‡ä»¶**: `src/memory/manager.ts`

```typescript
// SQLite å­˜å‚¨ + sqlite-vec å‘é‡æ‰©å±•
const VECTOR_TABLE = "chunks_vec";     // å‘é‡è¡¨
const FTS_TABLE = "chunks_fts";        // å…¨æ–‡æœç´¢è¡¨
const EMBEDDING_CACHE_TABLE = "embedding_cache";  // åµŒå…¥ç¼“å­˜

// å‘é‡è½¬ Blob å­˜å‚¨
const vectorToBlob = (embedding: number[]): Buffer =>
  Buffer.from(new Float32Array(embedding).buffer);
```

### 7.6 æ··åˆæœç´¢ç­–ç•¥

**æ–‡ä»¶**: `src/memory/hybrid.ts`

ç³»ç»Ÿé‡‡ç”¨**å‘é‡æœç´¢ + å…³é”®è¯æœç´¢**çš„æ··åˆç­–ç•¥ï¼Œå…ˆæ‰§è¡Œä¸¤è·¯å¹¶è¡Œæœç´¢ï¼Œå†èåˆç»“æœæ’åºï¼š

**æ•´ä½“æœç´¢æµç¨‹**ï¼š

```
ç”¨æˆ·æŸ¥è¯¢ "ä¸Šå‘¨çš„æ•°æ®åº“è®¾è®¡"
              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
      â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚å‘é‡åµŒå…¥  â”‚    â”‚å…³é”®è¯æå–â”‚
â”‚(è¯­ä¹‰è¡¨ç¤º)â”‚    â”‚(BM25)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚
      â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚sqlite-vecâ”‚    â”‚FTS5 å…¨æ–‡æœç´¢  â”‚
â”‚ ç›¸ä¼¼åº¦   â”‚    â”‚(SQLite å†…ç½®)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚æ··åˆç»“æœæ’åº  â”‚
      â”‚(0.7*å‘é‡ +   â”‚
      â”‚ 0.3*å…³é”®è¯)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
      Top N è®°å¿†ç‰‡æ®µ
```

#### ä¸¤ç§æœç´¢æŠ€æœ¯å¯¹æ¯”

| ç‰¹æ€§ | å‘é‡æœç´¢ (sqlite-vec) | å…³é”®è¯æœç´¢ (FTS5) |
|------|----------------------|-------------------|
| **åŸç†** | è®¡ç®—è¯­ä¹‰å‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦ | åŸºäºå€’æ’ç´¢å¼•çš„ BM25 è¯„åˆ† |
| **ä¼˜åŠ¿** | ç†è§£åŒä¹‰è¯ã€è¯­ä¹‰ç›¸è¿‘ | ç²¾ç¡®åŒ¹é…ã€é€Ÿåº¦å¿« |
| **åŠ£åŠ¿** | éœ€è¦ Embedding æ¨¡å‹ã€è¾ƒæ…¢ | ä¸ç†è§£åŒä¹‰è¯ |
| **ç¤ºä¾‹** | "æ¨é€" â‰ˆ "å‘é€" âœ… | "FTS5" å¿…é¡»ç²¾ç¡®åŒ¹é… |

- **å‘é‡æœç´¢**ï¼šä½¿ç”¨ `sqlite-vec` æ‰©å±•è¿›è¡Œè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—
- **å…³é”®è¯æœç´¢**ï¼šä½¿ç”¨ **SQLite å†…ç½®çš„ FTS5ï¼ˆFull-Text Search 5ï¼‰å…¨æ–‡ç´¢å¼•å¼•æ“**ï¼Œæ”¯æŒ BM25 ç›¸å…³æ€§æ’åº

> ğŸ’¡ FTS5 æ˜¯ SQLite åŸç”Ÿæ”¯æŒçš„å…¨æ–‡æœç´¢åŠŸèƒ½ï¼Œé€šè¿‡ `CREATE VIRTUAL TABLE ... USING fts5()` åˆ›å»ºè™šæ‹Ÿè¡¨ï¼Œä½¿ç”¨ `MATCH` è¯­æ³•è¿›è¡Œå…¨æ–‡æŸ¥è¯¢ï¼Œæ— éœ€é¢å¤–çš„æœç´¢å¼•æ“ä¾èµ–ã€‚

#### é»˜è®¤æƒé‡é…ç½®

```typescript
// src/agents/memory-search.ts
DEFAULT_HYBRID_VECTOR_WEIGHT = 0.7;       // å‘é‡æƒé‡ 70%
DEFAULT_HYBRID_TEXT_WEIGHT = 0.3;         // å…³é”®è¯æƒé‡ 30%
DEFAULT_HYBRID_CANDIDATE_MULTIPLIER = 4;  // å€™é€‰æ± æ‰©å¤§å€æ•°
```

#### æ··åˆç»“æœåˆå¹¶æ’åºç®—æ³•

**æ–‡ä»¶**: `src/memory/hybrid.ts` çš„ `mergeHybridResults` å‡½æ•°

æ··åˆæœç´¢çš„æ ¸å¿ƒæ˜¯**åŠ æƒçº¿æ€§ç»„åˆï¼ˆWeighted Linear Combinationï¼‰**ç®—æ³•ï¼š

```
æœ€ç»ˆå¾—åˆ† = vectorWeight Ã— vectorScore + textWeight Ã— textScore
         = 0.7 Ã— å‘é‡ç›¸ä¼¼åº¦ + 0.3 Ã— BM25å¾—åˆ†
```

**ç®—æ³•æ­¥éª¤**ï¼š

```typescript
// æ­¥éª¤ 1: ä½¿ç”¨ Map æŒ‰æ–‡æ¡£ ID å»ºç«‹ç´¢å¼•ï¼Œç”¨äºåˆå¹¶å»é‡
const byId = new Map<string, {
  id: string;
  vectorScore: number;  // å‘é‡å¾—åˆ†
  textScore: number;    // BM25 æ–‡æœ¬å¾—åˆ†
  // ... å…¶ä»–å­—æ®µ
}>();

// æ­¥éª¤ 2: å…ˆå¤„ç†å‘é‡æœç´¢ç»“æœ
for (const r of params.vector) {
  byId.set(r.id, {
    ...r,
    vectorScore: r.vectorScore,
    textScore: 0,  // åˆå§‹åŒ–æ–‡æœ¬å¾—åˆ†ä¸º 0
  });
}

// æ­¥éª¤ 3: å†å¤„ç†å…³é”®è¯æœç´¢ç»“æœï¼ˆåˆå¹¶åŒ ID çš„ç»“æœï¼‰
for (const r of params.keyword) {
  const existing = byId.get(r.id);
  if (existing) {
    // åŒä¸€æ–‡æ¡£åœ¨ä¸¤ç§æœç´¢ä¸­éƒ½å‘½ä¸­ï¼Œåˆå¹¶ textScore
    existing.textScore = r.textScore;
  } else {
    // ä»…åœ¨å…³é”®è¯æœç´¢ä¸­å‘½ä¸­ï¼ŒvectorScore ä¸º 0
    byId.set(r.id, { ...r, vectorScore: 0, textScore: r.textScore });
  }
}

// æ­¥éª¤ 4: è®¡ç®—åŠ æƒå¾—åˆ†å¹¶æ’åº
const merged = Array.from(byId.values()).map((entry) => ({
  ...entry,
  score: params.vectorWeight * entry.vectorScore 
       + params.textWeight * entry.textScore,
}));

// æ­¥éª¤ 5: æŒ‰æœ€ç»ˆå¾—åˆ†é™åºæ’åº
return merged.toSorted((a, b) => b.score - a.score);
```

#### BM25 åˆ†æ•°å½’ä¸€åŒ–

FTS5 çš„ `bm25()` å‡½æ•°è¿”å›**è´Ÿæ•°**æ’åå€¼ï¼ˆè¶Šè´Ÿè¶Šç›¸å…³ï¼Œå¦‚ -10 æ¯” -2 æ›´ç›¸å…³ï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸º 0-1 èŒƒå›´çš„æ­£åˆ†æ•°ï¼š

```typescript
// bm25RankToScore: å°† BM25 rank è½¬æ¢ä¸º 0-1 åˆ†æ•°
export function bm25RankToScore(rank: number): number {
  // è´Ÿæ•° â†’ Math.max(0, è´Ÿæ•°) = 0 â†’ 1/(1+0) = 1.0ï¼ˆæœ€ç›¸å…³ï¼‰
  // æ­£æ•°è¶Šå¤§ â†’ å¾—åˆ†è¶Šä½
  const normalized = Math.max(0, rank);
  return 1 / (1 + normalized);
}

// ç¤ºä¾‹ï¼š
// rank = -10ï¼ˆéå¸¸ç›¸å…³ï¼‰â†’ normalized = 0 â†’ score = 1.0
// rank = -2ï¼ˆç›¸å…³ï¼‰    â†’ normalized = 0 â†’ score = 1.0
// rank = 0            â†’ normalized = 0 â†’ score = 1.0
// rank = 1            â†’ normalized = 1 â†’ score = 0.5
// rank = 9            â†’ normalized = 9 â†’ score = 0.1
```

> ğŸ“ **æ³¨æ„**ï¼šç”±äº FTS5 è¿”å›è´Ÿæ•°è¡¨ç¤ºç›¸å…³ï¼Œ`Math.max(0, rank)` ä¼šå°†æ‰€æœ‰è´Ÿæ•°ï¼ˆé«˜ç›¸å…³ï¼‰éƒ½å½’ä¸€åŒ–ä¸º 0ï¼Œæœ€ç»ˆå¾—åˆ†ä¸º 1.0ã€‚è¿™æ˜¯ä¸€ç§ç®€åŒ–å¤„ç†ï¼Œç¡®ä¿ BM25 å‘½ä¸­çš„ç»“æœéƒ½è·å¾—é«˜åˆ†ã€‚

#### åˆå¹¶é€»è¾‘å›¾è§£

```
å‘é‡æœç´¢ç»“æœ                    å…³é”®è¯æœç´¢ç»“æœ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Doc A: vec=0.85     â”‚        â”‚ Doc A: text=0.60    â”‚
â”‚ Doc B: vec=0.72     â”‚        â”‚ Doc C: text=0.90    â”‚
â”‚ Doc D: vec=0.65     â”‚        â”‚ Doc E: text=0.45    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚    æŒ‰ ID åˆå¹¶    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Doc A: vec=0.85, text=0.60       â”‚ â† ä¸¤è¾¹éƒ½å‘½ä¸­
        â”‚ Doc B: vec=0.72, text=0.00       â”‚ â† ä»…å‘é‡å‘½ä¸­
        â”‚ Doc C: vec=0.00, text=0.90       â”‚ â† ä»…å…³é”®è¯å‘½ä¸­
        â”‚ Doc D: vec=0.65, text=0.00       â”‚
        â”‚ Doc E: vec=0.00, text=0.45       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼ è®¡ç®—åŠ æƒå¾—åˆ† (0.7Ã—vec + 0.3Ã—text)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Doc A: 0.7Ã—0.85 + 0.3Ã—0.60 = 0.775 â”‚
        â”‚ Doc B: 0.7Ã—0.72 + 0.3Ã—0.00 = 0.504 â”‚
        â”‚ Doc D: 0.7Ã—0.65 + 0.3Ã—0.00 = 0.455 â”‚
        â”‚ Doc C: 0.7Ã—0.00 + 0.3Ã—0.90 = 0.270 â”‚
        â”‚ Doc E: 0.7Ã—0.00 + 0.3Ã—0.45 = 0.135 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼ é™åºæ’åº + è¿‡æ»¤ minScore(0.35) + æˆªå– Top N
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 1. Doc A (0.775) âœ…               â”‚
        â”‚ 2. Doc B (0.504) âœ…               â”‚
        â”‚ 3. Doc D (0.455) âœ…               â”‚
        â”‚ 4. Doc C (0.270) âŒ < minScore    â”‚
        â”‚ 5. Doc E (0.135) âŒ < minScore    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä¸ºä»€ä¹ˆè¿™ç§ç®—æ³•æœ‰æ•ˆï¼Ÿ

| åœºæ™¯ | å‘é‡å¾—åˆ† | BM25å¾—åˆ† | æœ€ç»ˆæ•ˆæœ |
|------|---------|---------|---------|
| è¯­ä¹‰ç›¸ä¼¼ä½†å…³é”®è¯ä¸åŒ | é«˜ | ä½ | 0.7Ã—é«˜ + 0.3Ã—ä½ = è¾ƒé«˜ âœ… |
| å…³é”®è¯ç²¾ç¡®åŒ¹é… | ä½ | é«˜ | 0.7Ã—ä½ + 0.3Ã—é«˜ = ä¸­ç­‰ âœ… |
| ä¸¤è€…éƒ½åŒ¹é… | é«˜ | é«˜ | 0.7Ã—é«˜ + 0.3Ã—é«˜ = æœ€é«˜ âœ…âœ… |
| ä¸¤è€…éƒ½ä¸åŒ¹é… | ä½ | ä½ | è¢« minScore è¿‡æ»¤ âŒ |

> ğŸ’¡ **è®¾è®¡ç†å¿µ**ï¼šå‘é‡æœç´¢æ“…é•¿ç†è§£è¯­ä¹‰ï¼ˆ"æ¨é€"â‰ˆ"å‘é€"ï¼‰ï¼Œå…³é”®è¯æœç´¢æ“…é•¿ç²¾ç¡®åŒ¹é…ï¼ˆ"FTS5"å¿…é¡»å®Œå…¨åŒ¹é…ï¼‰ã€‚70:30 çš„æƒé‡åå‘è¯­ä¹‰æœç´¢ï¼ŒåŒæ—¶ä¿ç•™å…³é”®è¯ç²¾ç¡®åŒ¹é…çš„èƒ½åŠ›ã€‚

### 7.7 è®°å¿†æ–‡ä»¶æŸ¥çœ‹æ—¶æœº

è®°å¿†æ–‡ä»¶**ä¸æ˜¯**åœ¨æ¯æ¬¡å¯¹è¯æ—¶è‡ªåŠ¨å…¨é‡åŠ è½½åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œè€Œæ˜¯**æŒ‰éœ€æŸ¥è¯¢**ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§æŸ¥çœ‹æ—¶æœºï¼š

#### Agent ä¸»åŠ¨è°ƒç”¨ï¼ˆæœ€å¸¸è§ï¼‰

å½“ LLM éœ€è¦å›ç­”æ¶‰åŠå†å²ä¿¡æ¯çš„é—®é¢˜æ—¶ï¼Œä¼šä¸»åŠ¨è°ƒç”¨ `memory_search` å’Œ `memory_get` å·¥å…·ã€‚

**ç³»ç»Ÿæç¤ºè¯ä¸­çš„è®°å¿†å¬å›æŒ‡ä»¤**ï¼š

```
## Memory Recall

Before answering anything about prior work, decisions, dates, people, 
preferences, or todos: run memory_search on MEMORY.md + memory/*.md; 
then use memory_get to pull only needed lines. 
If low confidence after search, say you checked.
```

**è§¦å‘åœºæ™¯**ï¼š

| åœºæ™¯ | ç¤ºä¾‹é—®é¢˜ |
|------|---------|
| è¿‡å»çš„å·¥ä½œ | "æˆ‘ä¸Šå‘¨è®©ä½ å†™çš„é‚£ä¸ª API å«ä»€ä¹ˆï¼Ÿ" |
| å†å²å†³ç­– | "æˆ‘ä»¬ä¸ºä»€ä¹ˆé€‰æ‹©äº†è¿™ä¸ªæŠ€æœ¯æ–¹æ¡ˆï¼Ÿ" |
| æ—¥æœŸç›¸å…³ | "ä¸Šæ¬¡éƒ¨ç½²æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ" |
| äººç‰©ä¿¡æ¯ | "å°æ˜è´Ÿè´£å“ªä¸ªæ¨¡å—ï¼Ÿ" |
| ç”¨æˆ·åå¥½ | "æˆ‘å–œæ¬¢ä»€ä¹ˆä»£ç é£æ ¼ï¼Ÿ" |
| å¾…åŠäº‹é¡¹ | "æˆ‘è¿˜æœ‰å“ªäº›äº‹æƒ…æ²¡å®Œæˆï¼Ÿ" |

**æŸ¥è¯¢æµç¨‹å›¾**ï¼š

```
ç”¨æˆ·: "æˆ‘ä¸Šå‘¨è®©ä½ å†™çš„é‚£ä¸ª API å«ä»€ä¹ˆï¼Ÿ"
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent åˆ¤æ–­ï¼šéœ€è¦æŸ¥è¯¢å†å²è®°å¿†           â”‚
â”‚                                        â”‚
â”‚ 1. è°ƒç”¨ memory_search("ä¸Šå‘¨ API")      â”‚
â”‚    â†’ è¿”å›ç›¸å…³ç‰‡æ®µ + è¡Œå·               â”‚
â”‚                                        â”‚
â”‚ 2. è°ƒç”¨ memory_get(path, from, lines)  â”‚
â”‚    â†’ è·å–è¯¦ç»†å†…å®¹                      â”‚
â”‚                                        â”‚
â”‚ 3. åŸºäºæ£€ç´¢åˆ°çš„ä¿¡æ¯ç”Ÿæˆå›ç­”            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç´¢å¼•åŒæ­¥æ—¶æœºï¼ˆåå°è‡ªåŠ¨ï¼‰

è®°å¿†æ–‡ä»¶çš„**ç´¢å¼•**ä¼šåœ¨ä»¥ä¸‹æ—¶æœºè‡ªåŠ¨åŒæ­¥ï¼ˆä½†ä¸æ˜¯åŠ è½½åˆ°å¯¹è¯ä¸Šä¸‹æ–‡ï¼‰ï¼š

```typescript
sync: {
  onSessionStart: boolean;   // ä¼šè¯å¼€å§‹æ—¶åŒæ­¥ç´¢å¼•
  onSearch: boolean;         // æœç´¢æ—¶æ‡’åŒæ­¥
  watch: boolean;            // æ–‡ä»¶å˜æ›´ç›‘è§†ï¼ˆå®æ—¶ï¼‰
  watchDebounceMs: number;   // é˜²æŠ–é—´éš” 1500ms
}
```

| åŒæ­¥æ—¶æœº | è¯´æ˜ | ç”¨é€” |
|---------|------|------|
| `onSessionStart` | ä¼šè¯å¼€å§‹æ—¶ | ç¡®ä¿ç´¢å¼•ä¸æ–‡ä»¶ä¸€è‡´ |
| `onSearch` | é¦–æ¬¡æœç´¢æ—¶ | æ‡’åŠ è½½ä¼˜åŒ–å¯åŠ¨é€Ÿåº¦ |
| `watch` | æ–‡ä»¶å˜æ›´æ—¶ | å®æ—¶ä¿æŒç´¢å¼•æœ€æ–° |

#### CLI æ‰‹åŠ¨æŸ¥è¯¢

ç”¨æˆ·å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œä¸»åŠ¨æŸ¥è¯¢è®°å¿†ï¼š

```bash
# æœç´¢è®°å¿†
openclaw memory search "API è®¾è®¡"

# æŸ¥çœ‹è®°å¿†å†…å®¹
openclaw memory cat memory/2026-01-16.md
```

#### å…³é”®è®¾è®¡ç†å¿µ

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **æŒ‰éœ€åŠ è½½** | è®°å¿†ä¸ä¼šå…¨é‡åŠ è½½ï¼Œåªåœ¨éœ€è¦æ—¶è¯­ä¹‰æœç´¢ |
| **ä¸¤æ­¥æ£€ç´¢** | å…ˆ `memory_search` å®šä½ï¼Œå† `memory_get` è·å–è¯¦æƒ… |
| **èŠ‚çœä¸Šä¸‹æ–‡** | é¿å…æµªè´¹å®è´µçš„ä¸Šä¸‹æ–‡çª—å£ç©ºé—´ |
| **è¯­ä¹‰æœç´¢** | æ”¯æŒç›¸è¿‘æ¦‚å¿µåŒ¹é…ï¼ˆå¦‚"æ¨é€"â‰ˆ"å‘é€"ï¼‰ |

> ğŸ’¡ è¿™ç§è®¾è®¡é¿å…äº†å°†æ‰€æœ‰è®°å¿†æ–‡ä»¶å¡è¿›ä¸Šä¸‹æ–‡é€ æˆçš„ token æµªè´¹ï¼ŒåŒæ—¶ä¿è¯äº† Agent èƒ½åœ¨éœ€è¦æ—¶å‡†ç¡®å¬å›ç›¸å…³ä¿¡æ¯ã€‚

### 7.8 è®°å¿†å·¥å…·

**æ–‡ä»¶**: `src/agents/tools/memory-tool.ts`

#### memory_search å·¥å…·

```typescript
{
  name: "memory_search",
  description: "Mandatory recall step: semantically search MEMORY.md + memory/*.md 
                before answering questions about prior work, decisions, dates, 
                people, preferences, or todos",
  parameters: {
    query: string,        // æœç´¢æŸ¥è¯¢
    maxResults?: number,  // æœ€å¤§ç»“æœæ•° (é»˜è®¤ 6)
    minScore?: number,    // æœ€å°åˆ†æ•°é˜ˆå€¼ (é»˜è®¤ 0.35)
  }
}
```

#### memory_get å·¥å…·

```typescript
{
  name: "memory_get",
  description: "Safe snippet read from MEMORY.md, memory/*.md with optional 
                from/lines; use after memory_search to pull only needed lines",
  parameters: {
    path: string,    // æ–‡ä»¶è·¯å¾„
    from?: number,   // èµ·å§‹è¡Œ
    lines?: number,  // è¯»å–è¡Œæ•°
  }
}
```

**ä½¿ç”¨æµç¨‹**ï¼š

```
Agent æ”¶åˆ°é—®é¢˜ "æˆ‘ä¸Šå‘¨è®©ä½ å†™çš„é‚£ä¸ª API å«ä»€ä¹ˆï¼Ÿ"
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚memory_searchâ”‚  â† å…ˆè¯­ä¹‰æœç´¢
       â”‚"ä¸Šå‘¨ API"  â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
       è¿”å›ç›¸å…³ç‰‡æ®µ:
       - memory/projects.md:15-25 (score: 0.82)
       - MEMORY.md:100-110 (score: 0.65)
              â”‚
              â–¼
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚ memory_get â”‚  â† è·å–è¯¦ç»†å†…å®¹
       â”‚ path, from â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
       Agent ç”Ÿæˆå›ç­”
```

### 7.9 é…ç½®å‚æ•°

**æ–‡ä»¶**: `src/agents/memory-search.ts`

```typescript
export type ResolvedMemorySearchConfig = {
  enabled: boolean;                    // æ˜¯å¦å¯ç”¨
  sources: Array<"memory" | "sessions">;  // è®°å¿†æ¥æº
  extraPaths: string[];               // é¢å¤–æ–‡ä»¶è·¯å¾„
  
  provider: "openai" | "local" | "gemini" | "auto";  // åµŒå…¥æä¾›è€…
  fallback: "openai" | "gemini" | "local" | "none";  // å›é€€ç­–ç•¥
  model: string;                      // åµŒå…¥æ¨¡å‹
  
  store: {
    driver: "sqlite";
    path: string;                     // ~/.openclaw/memory/{agentId}.sqlite
    vector: {
      enabled: boolean;
      extensionPath?: string;         // sqlite-vec æ‰©å±•è·¯å¾„
    };
  };
  
  chunking: {
    tokens: number;                   // 400
    overlap: number;                  // 80
  };
  
  sync: {
    onSessionStart: boolean;          // ä¼šè¯å¼€å§‹æ—¶åŒæ­¥
    onSearch: boolean;                // æœç´¢æ—¶åŒæ­¥
    watch: boolean;                   // æ–‡ä»¶ç›‘è§†
    watchDebounceMs: number;          // 1500ms
  };
  
  query: {
    maxResults: number;               // 6
    minScore: number;                 // 0.35
    hybrid: {
      enabled: boolean;               // true
      vectorWeight: number;           // 0.7
      textWeight: number;             // 0.3
      candidateMultiplier: number;    // 4
    };
  };
  
  cache: {
    enabled: boolean;                 // true
    maxEntries?: number;
  };
};
```

**é…ç½®ç¤ºä¾‹** (`~/.openclaw/config.yaml`):

```yaml
agents:
  defaults:
    memorySearch:
      enabled: true
      provider: auto
      sources:
        - memory
      extraPaths:
        - ~/notes/project-docs.md
      query:
        maxResults: 10
        minScore: 0.4
        hybrid:
          vectorWeight: 0.8
          textWeight: 0.2
```

---

## å…«ã€è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 8.1 æ’ä»¶åŒ–æ¶æ„

æ‰€æœ‰æ¸ é“å’Œæ‰©å±•åŠŸèƒ½éƒ½é€šè¿‡æ’ä»¶ç³»ç»Ÿå®ç°ï¼Œæ’ä»¶å¯æ³¨å†Œçš„æ‰©å±•ç‚¹åŒ…æ‹¬ï¼š

| ç±»å‹ | è¯´æ˜ |
|------|------|
| ğŸ”§ **Tools** | è‡ªå®šä¹‰ Agent å·¥å…· |
| ğŸª **Hooks** | ç”Ÿå‘½å‘¨æœŸé’©å­ |
| ğŸŒ **HTTP Routes** | HTTP ç«¯ç‚¹ |
| ğŸ“¡ **Channels** | æ¶ˆæ¯æ¸ é“ |
| ğŸ–¥ï¸ **CLI Commands** | å‘½ä»¤è¡Œå‘½ä»¤ |
| âš™ï¸ **Services** | åå°æœåŠ¡ |

### 8.2 äº‹ä»¶é©±åŠ¨è®¾è®¡

Gateway ä½¿ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å‹è¿›è¡Œå®æ—¶é€šä¿¡ï¼š

**æ–‡ä»¶**: `src/gateway/server-chat.ts`

```typescript
export function createAgentEventHandler({
  broadcast,
  nodeSendToSession,
  agentRunSeq,
  chatRunState,
}: AgentEventHandlerOptions) {
  const emitChatDelta = (sessionKey: string, clientRunId: string, seq: number, text: string) => {
    // èŠ‚æµï¼š150ms å†…åªå‘é€ä¸€æ¬¡
    const now = Date.now();
    const last = chatRunState.deltaSentAt.get(clientRunId) ?? 0;
    if (now - last < 150) {
      return;
    }
    
    // å¹¿æ’­åˆ°æ‰€æœ‰å®¢æˆ·ç«¯
    broadcast("chat", payload, { dropIfSlow: true });
    
    // å‘é€åˆ°ç‰¹å®šä¼šè¯
    nodeSendToSession(sessionKey, "chat", payload);
  };
}
```

### 8.3 å¹¶å‘æ§åˆ¶

ä½¿ç”¨ **Lane (è½¦é“)** æ¦‚å¿µè¿›è¡Œå¹¶å‘æ§åˆ¶ï¼ˆè¯¦è§ [4.2 Agent è¿è¡Œä¸»å…¥å£](#42-agent-è¿è¡Œä¸»å…¥å£)ï¼‰ï¼š

- **ä¼šè¯çº§é˜Ÿåˆ—**: åŒä¸€ä¼šè¯çš„æ¶ˆæ¯ä¸²è¡Œå¤„ç†ï¼Œé¿å…å¹¶å‘å†²çª
- **å…¨å±€é˜Ÿåˆ—**: å…¨å±€èµ„æºï¼ˆå¦‚æ¨¡å‹è°ƒç”¨ï¼‰çš„å¹¶å‘é™åˆ¶

### 8.4 æ ¸å¿ƒè®¾è®¡äº®ç‚¹æ€»ç»“

#### ä¸Šä¸‹æ–‡ç®¡ç†

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|----------|------|
| **åˆ†å±‚è£å‰ª** | è½¯è£å‰ª â†’ ç¡¬æ¸…é™¤ | æ¸è¿›å¼é™çº§ï¼Œä¿ç•™æœ€å¤§ä¿¡æ¯ |
| **åˆ†é˜¶æ®µæ‘˜è¦** | åˆ†å— â†’ ç‹¬ç«‹æ‘˜è¦ â†’ åˆå¹¶ | å¤„ç†è¶…å¤§ä¸Šä¸‹æ–‡ |
| **å®‰å…¨è¾¹ç•Œ** | 20% buffer | é˜²æ­¢ä¼°ç®—è¯¯å·®å¯¼è‡´æº¢å‡º |
| **Bootstrap ä¿æŠ¤** | é¦–ä¸ªç”¨æˆ·æ¶ˆæ¯å‰ä¸è£å‰ª | ä¿ç•™å…³é”®åˆå§‹åŒ–ä¿¡æ¯ |
| **å†å²é™åˆ¶** | æŒ‰ç”¨æˆ·/æ¸ é“é…ç½® | ç²¾ç»†æ§åˆ¶ä¸åŒåœºæ™¯ |

#### Skills ç³»ç»Ÿ

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|----------|------|
| **å£°æ˜å¼ä¾èµ–** | YAML frontmatter | è‡ªåŠ¨æ£€æŸ¥å¯ç”¨æ€§ |
| **ä¼˜å…ˆçº§è¦†ç›–** | workspace > managed > bundled | æ”¯æŒè‡ªå®šä¹‰è¦†ç›– |
| **æ‡’åŠ è½½** | åªè¯»å–é€‰ä¸­çš„ SKILL.md | å‡å°‘ä¸Šä¸‹æ–‡æ¶ˆè€— |
| **çƒ­åˆ·æ–°** | chokidar æ–‡ä»¶ç›‘è§† | æ— éœ€é‡å¯å³å¯æ›´æ–° |
| **æ’ä»¶ Skills** | resolvePluginSkillDirs | æ‰©å±•èƒ½åŠ›å¼º |

#### è®°å¿†ç³»ç»Ÿ

| ç‰¹æ€§ | å®ç°æ–¹å¼ | ä¼˜åŠ¿ |
|------|----------|------|
| **æŒ‰éœ€æ£€ç´¢** | Agent ä¸»åŠ¨è°ƒç”¨å·¥å…· | é¿å…å…¨é‡åŠ è½½æµªè´¹ Token |
| **ä¸¤æ­¥æ£€ç´¢** | memory_search â†’ memory_get | ç²¾å‡†å®šä½ï¼Œå‡å°‘å™ªéŸ³ |
| **æ··åˆæœç´¢** | å‘é‡ 70% + BM25 30% | è¯­ä¹‰ç†è§£ + ç²¾ç¡®åŒ¹é… |
| **å¢é‡ç´¢å¼•** | æ–‡ä»¶ hash å˜æ›´æ£€æµ‹ | åªæ›´æ–°å˜åŒ–çš„å†…å®¹ |
| **å¤šæºæ”¯æŒ** | MEMORY.md + memory/*.md | é•¿æœŸè®°å¿† + æ—¥å¿—è®°å¿† |
| **è‡ªåŠ¨ç”Ÿæˆ** | session-memory Hook | /new æ—¶è‡ªåŠ¨ä¿å­˜ä¼šè¯ |
| **åµŒå…¥å›é€€** | OpenAI â†’ Gemini â†’ Local | ä¿è¯å¯ç”¨æ€§ |

---

## ä¹ã€æ€»ç»“

### 9.1 Agent ç³»ç»Ÿå¼€å‘çš„æ ¸å¿ƒèƒ½åŠ›çŸ©é˜µ

æ„å»ºä¸€ä¸ªå®Œæ•´çš„ Agent ç³»ç»Ÿéœ€è¦ä»ä»¥ä¸‹å››ä¸ªæ ¸å¿ƒç»´åº¦è€ƒè™‘ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Agent ç³»ç»Ÿæ ¸å¿ƒèƒ½åŠ›                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚    æ„ŸçŸ¥å±‚    â”‚    æ¨ç†å±‚    â”‚    è®°å¿†å±‚    â”‚    è¡ŒåŠ¨å±‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤šæ¸ é“è¾“å…¥   â”‚ LLM è°ƒç”¨     â”‚ çŸ­æœŸè®°å¿†     â”‚ å·¥å…·è°ƒç”¨      â”‚
â”‚ æ¶ˆæ¯è§£æ     â”‚ æç¤ºè¯å·¥ç¨‹   â”‚ é•¿æœŸè®°å¿†     â”‚ ä»£ç æ‰§è¡Œ      â”‚
â”‚ æ–‡ä»¶è¯»å–     â”‚ æ€ç»´é“¾       â”‚ å‘é‡æ£€ç´¢     â”‚ æ–‡ä»¶æ“ä½œ      â”‚
â”‚ ç”¨æˆ·æ„å›¾è¯†åˆ« â”‚ å¤šè½®å¯¹è¯     â”‚ ä¼šè¯å†å²     â”‚ å¤–éƒ¨ API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

OpenClaw åœ¨è¿™å››ä¸ªç»´åº¦çš„å®ç°ï¼š

| ç»´åº¦ | OpenClaw å®ç° | å…³é”®æ–‡ä»¶/æ¨¡å— |
|------|---------------|---------------|
| **æ„ŸçŸ¥å±‚** | Telegram/Discord/Slack/WhatsApp ç­‰å¤šæ¸ é“ç»Ÿä¸€æ¥å…¥ | `src/channels/`, `src/routing/` |
| **æ¨ç†å±‚** | å¤šæ¨¡å‹æ”¯æŒ + ç»“æ„åŒ–ç³»ç»Ÿæç¤ºè¯ + ä¸Šä¸‹æ–‡å·¥ç¨‹ | `src/agents/system-prompt.ts`, `src/agents/compaction.ts` |
| **è®°å¿†å±‚** | å‘é‡æ£€ç´¢ + BM25 æ··åˆæœç´¢ + æŒ‰éœ€åŠ è½½ | `src/memory/`, `src/agents/memory-search.ts` |
| **è¡ŒåŠ¨å±‚** | å¯æ‰©å±•å·¥å…·ç³»ç»Ÿ + Skills åŠ¨æ€åŠ è½½ | `src/agents/tools/`, `src/agents/skills/` |

### 9.2 OpenClaw çš„æŠ€æœ¯æ¶æ„æ€»ç»“

ä»ä¸€ä¸ªå®Œæ•´ Agent ç³»ç»Ÿçš„è§†è§’ï¼ŒOpenClaw çš„æ¶æ„å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å±‚æ¬¡ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·äº¤äº’å±‚                                â”‚
â”‚  Telegram â”‚ Discord â”‚ Slack â”‚ WhatsApp â”‚ Web â”‚ CLI â”‚ æ’ä»¶æ¸ é“      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           ç½‘å…³è·¯ç”±å±‚                                â”‚
â”‚         æ¶ˆæ¯è·¯ç”± â”‚ ä¼šè¯ç®¡ç† â”‚ æƒé™æ ¡éªŒ â”‚ é…é¢æ§åˆ¶                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           Agent æ ¸å¿ƒå±‚                              â”‚
â”‚  ç³»ç»Ÿæç¤ºè¯ â”‚ ä¸Šä¸‹æ–‡ç®¡ç† â”‚ å·¥å…·è°ƒåº¦ â”‚ Skills ç³»ç»Ÿ â”‚ è®°å¿†æ£€ç´¢        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           æ¨¡å‹é€‚é…å±‚                                â”‚
â”‚         OpenAI â”‚ Claude â”‚ Gemini â”‚ Ollama â”‚ æ›´å¤šæä¾›å•†...           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                           åŸºç¡€è®¾æ–½å±‚                                â”‚
â”‚     SQLite å­˜å‚¨ â”‚ å‘é‡ç´¢å¼• â”‚ æ–‡ä»¶ç³»ç»Ÿ â”‚ WebSocket â”‚ äº‹ä»¶æ€»çº¿        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æŠ€æœ¯é€‰å‹æ€»ç»“**ï¼š

| å±‚æ¬¡ | æŠ€æœ¯é€‰å‹ | é€‰å‹ç†ç”± |
|------|----------|----------|
| è¯­è¨€ | TypeScript (ESM) | ç±»å‹å®‰å…¨ã€ç”Ÿæ€ä¸°å¯Œã€å‰åç«¯ç»Ÿä¸€ |
| è¿è¡Œæ—¶ | Node.js + Bun | ç”Ÿäº§ç¨³å®š + å¼€å‘é«˜æ•ˆ |
| å­˜å‚¨ | SQLite + sqlite-vec | æœ¬åœ°ä¼˜å…ˆã€é›¶ä¾èµ–ã€æ”¯æŒå‘é‡ |
| éªŒè¯ | Zod + TypeBox | è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ã€LLM è¾“å‡ºæ ¡éªŒ |
| é€šä¿¡ | WebSocket + EventEmitter | å®æ—¶åŒå‘ã€äº‹ä»¶è§£è€¦ |
| æ„å»º | tsup + Vitest | ç°ä»£åŒ–å·¥å…·é“¾ã€å¿«é€Ÿæµ‹è¯• |

### 9.3 æ„å»ºç”Ÿäº§çº§ Agent ç³»ç»Ÿçš„å…³é”®è€ƒé‡

é€šè¿‡åˆ†æ OpenClawï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºæ„å»ºç”Ÿäº§çº§ Agent ç³»ç»Ÿéœ€è¦å…³æ³¨çš„å…³é”®ç‚¹ï¼š

#### 1. ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼ˆContext Engineeringï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| Token è¶…é™ | æ™ºèƒ½è£å‰ª + å‹ç¼©å®‰å…¨æœºåˆ¶ |
| ä¿¡æ¯ä¸¢å¤± | ä¿ç•™ç³»ç»Ÿæç¤ºè¯ + å…³é”®æ¶ˆæ¯ |
| æˆæœ¬æ§åˆ¶ | Token ä¼°ç®— + å†å²é™åˆ¶ |
| ä¿¡æ¯æ³¨å…¥ | åˆ†å±‚ä¸Šä¸‹æ–‡ï¼ˆç³»ç»Ÿ/ä¼šè¯/å·¥å…·ï¼‰ |

#### 2. è®°å¿†ç³»ç»Ÿï¼ˆMemory Systemï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| é•¿æœŸè®°å¿† | MEMORY.md + memory/*.md |
| æ£€ç´¢æ•ˆç‡ | å‘é‡æœç´¢ + BM25 æ··åˆ |
| å¢é‡æ›´æ–° | Hash å˜æ›´æ£€æµ‹ |
| æŒ‰éœ€åŠ è½½ | ä¸¤æ­¥æ£€ç´¢ï¼ˆsearch â†’ getï¼‰ |

#### 3. å¯æ‰©å±•æ€§ï¼ˆExtensibilityï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| åŠŸèƒ½æ‰©å±• | æ’ä»¶ç³»ç»Ÿ + Skills ç³»ç»Ÿ |
| æ¸ é“æ‰©å±• | ç»Ÿä¸€æ¶ˆæ¯æŠ½è±¡ + è·¯ç”±å±‚ |
| æ¨¡å‹æ‰©å±• | Provider æŠ½è±¡å±‚ |
| å·¥å…·æ‰©å±• | å£°æ˜å¼å·¥å…·æ³¨å†Œ |

#### 4. å¯é æ€§ï¼ˆReliabilityï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| æ¨¡å‹é™çº§ | å¤š Provider å›é€€é“¾ |
| åµŒå…¥å›é€€ | OpenAI â†’ Gemini â†’ Local |
| ä¼šè¯æ¢å¤ | æœ¬åœ°æŒä¹…åŒ–ä¼šè¯ |
| é”™è¯¯å¤„ç† | åˆ†å±‚é”™è¯¯è¾¹ç•Œ |

#### 5. å®‰å…¨æ€§ï¼ˆSecurityï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| æ•æ„Ÿä¿¡æ¯ | æœ¬åœ°å­˜å‚¨å‡­è¯ |
| æƒé™æ§åˆ¶ | ç™½åå•æœºåˆ¶ |
| å·¥å…·æ²™ç®± | æ‰§è¡Œç¯å¢ƒéš”ç¦» |
| è¾“å…¥æ ¡éªŒ | Zod Schema éªŒè¯ |

#### 6. å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰

| é—®é¢˜ | OpenClaw è§£å†³æ–¹æ¡ˆ |
|------|-------------------|
| æ—¥å¿—è¿½è¸ª | ä¼šè¯æ—¥å¿— + äº‹ä»¶æµ |
| çŠ¶æ€ç›‘æ§ | CLI status å‘½ä»¤ |
| è¯Šæ–­å·¥å…· | openclaw doctor |
| è°ƒè¯•æ”¯æŒ | è¯¦ç»†é”™è¯¯ä¸Šä¸‹æ–‡ |

### 9.4 å­¦ä¹ ä»·å€¼ä¸å®è·µå»ºè®®

OpenClaw ä½œä¸ºä¸€ä¸ªç”Ÿäº§çº§ Agent ç³»ç»Ÿï¼Œæ¶µç›–äº† Agent å¼€å‘çš„æ ¸å¿ƒçŸ¥è¯†é¢†åŸŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å­¦ä¹ ä»·å€¼çŸ©é˜µ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   åŸºç¡€æ¶æ„      â”‚ TypeScript å·¥ç¨‹åŒ–ã€æ’ä»¶ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   AI å·¥ç¨‹       â”‚ æç¤ºè¯å·¥ç¨‹ã€ä¸Šä¸‹æ–‡ç®¡ç†ã€å·¥å…·è°ƒç”¨        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   è®°å¿†ç³»ç»Ÿ      â”‚ å‘é‡æ£€ç´¢ã€æ··åˆæœç´¢ã€å¢é‡ç´¢å¼•            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   å¤šç«¯é€‚é…      â”‚ å¤šæ¸ é“æŠ½è±¡ã€æ¶ˆæ¯è·¯ç”±ã€åè®®é€‚é…          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   ç”Ÿäº§å®è·µ      â”‚ é”™è¯¯å¤„ç†ã€é™çº§ç­–ç•¥ã€å¯è§‚æµ‹æ€§            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å»ºè®®çš„å­¦ä¹ è·¯å¾„**ï¼š

| é˜¶æ®µ | ç›®æ ‡ | é‡ç‚¹æ¨¡å— |
|------|------|----------|
| **å…¥é—¨** | ç†è§£ Agent åŸºæœ¬åŸç† | ç³»ç»Ÿæç¤ºè¯ã€å·¥å…·è°ƒç”¨ |
| **è¿›é˜¶** | æŒæ¡ä¸Šä¸‹æ–‡å·¥ç¨‹ | å‹ç¼©ç­–ç•¥ã€è®°å¿†æ£€ç´¢ã€Skills |
| **æ·±å…¥** | ç†è§£æ¶æ„è®¾è®¡ | æ’ä»¶ç³»ç»Ÿã€äº‹ä»¶é©±åŠ¨ã€å¤šæ¸ é“ |
| **å®æˆ˜** | æ„å»ºè‡ªå·±çš„ Agent | å‚è€ƒå„æ¨¡å—æœ€ä½³å®è·µ |

---

**æ€»ç»“**ï¼šOpenClaw å±•ç¤ºäº†ä¸€ä¸ªç°ä»£ Agent ç³»ç»Ÿåº”æœ‰çš„å®Œæ•´å½¢æ€â€”â€”ä¸ä»…æ˜¯è°ƒç”¨ LLM çš„ç®€å•å°è£…ï¼Œè€Œæ˜¯ä¸€ä¸ªè€ƒè™‘äº†æ„ŸçŸ¥ã€æ¨ç†ã€è®°å¿†ã€è¡ŒåŠ¨å…¨é“¾è·¯ï¼Œå…¼é¡¾å¯æ‰©å±•æ€§ã€å¯é æ€§ã€å®‰å…¨æ€§ã€å¯è§‚æµ‹æ€§çš„ç”Ÿäº§çº§ç³»ç»Ÿã€‚

---

*æ–‡æ¡£ç”Ÿæˆæ—¶é—´: 2026-02-02*
